<!DOCTYPE html>
<html lang="ca" x-data="{ tema: localStorage.getItem('tema') || 'clar' }" :class="{ 'dark': tema === 'fosc' }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <title>Traductor de Veu en Temps Real - Client Aut√≤nom</title> -->
    <title>Veu en moviment</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./imatges/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./imatges/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./imatges/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link href="./output.css" rel="stylesheet">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        /* Estils per al loader */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
    <!-- <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script> -->
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div id="app" class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row items-start md:items-center w-full gap-4">
        
                <!-- LOGO -->
                <div class="flex items-center space-x-4 logo">
                    <img src="./imatges/veuenmoviment.png" alt="Example" width="72" height="72">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
                            Veu en moviment
                        </h1>
                        <h5 class="text-sm font-semibold text-gray-600 mb-0">
                            Traductor de Veu en temps real
                        </h5>
                    </div>
                </div>
        
                <!-- MENU -->
                <!--  mt-2 nom√©s en m√≤bil | ml-auto a md+ per arraconar a la dreta -->
                <div class="flex gap-2 menu mt-2 md:mt-0 md:ml-auto">
                    <button 
                        @click="tema = tema === 'clar' ? 'fosc' : 'clar'; localStorage.setItem('tema', tema)"
                        class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white">
                        <span x-text="tema === 'clar' ? 'üåô' : '‚òÄÔ∏è'"></span>
                    </button>
        
                    <button 
                        id="boto-configuracio"
                        class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        </header>

        <!-- Formulari de configuraci√≥ de l'API -->
        <div id="modal-configuracio" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="fixed inset-0 bg-black bg-opacity-50" id="tanca-modal"></div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md z-10">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Configuraci√≥ API</h2>
                    <button id="tanca-configuracio" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        ‚úï
                    </button>
                </div>
                <form id="form-api" class="space-y-4">
                    <div>
                        <label for="api-key" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Clau API d'OpenAI
                        </label>
                        <input type="password" id="api-key" name="api-key" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                    bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                    focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="mostrar-api-key" class="mr-2">
                            <label for="mostrar-api-key" class="text-sm text-gray-600 dark:text-gray-400">
                                Mostrar clau
                            </label>
                        </div>
                    </div>
                    <!-- Secci√≥ de configuraci√≥ de veus -->
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                        <h3 class="text-md font-semibold text-gray-800 dark:text-white mb-3">Configuraci√≥ de veus</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Veu per idioma original -->
                            <div>
                                <label for="veu-original" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    Veu per √†udio original
                                </label>
                                <select id="veu-original" 
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                                bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                                focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <optgroup label="Veus masculines">
                                        <option value="alloy">Alloy</option>
                                        <option value="echo">Echo</option>
                                        <option value="fable">Fable</option>
                                        <option value="onyx">Onyx</option>
                                        <option value="ash">Ash</option>
                                        <option value="balland">Balland</option>
                                        <option value="verse">Verse</option>
                                    </optgroup>
                                    <optgroup label="Veus femenines">
                                        <option value="nova">Nova</option>
                                        <option value="shimmer">Shimmer</option>
                                        <option value="coral">Coral</option>
                                        <option value="sage">Sage</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <!-- Veu per idioma tradu√Øt -->
                            <div>
                                <label for="veu-traduida" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    Veu per √†udio tradu√Øt
                                </label>
                                <select id="veu-traduida" 
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                                bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                                focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <optgroup label="Veus masculines">
                                        <option value="alloy">Alloy</option>
                                        <option value="echo">Echo</option>
                                        <option value="fable">Fable</option>
                                        <option value="onyx">Onyx</option>
                                        <option value="ash">Ash</option>
                                        <option value="balland">Balland</option>
                                        <option value="verse">Verse</option>
                                    </optgroup>
                                    <optgroup label="Veus femenines">
                                        <option value="nova">Nova</option>
                                        <option value="shimmer">Shimmer</option>
                                        <option value="coral">Coral</option>
                                        <option value="sage">Sage</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>                    
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <p>La clau API es desar√† localment al teu navegador i mai s'enviar√† al nostre servidor.</p>
                        <p class="mt-1">Si no tens una clau API d'OpenAI, pots obtenir-ne una a <a href="https://platform.openai.com/account/api-keys" target="_blank" class="text-blue-500 hover:underline">platform.openai.com</a></p>
                    </div>
                    <button type="submit" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded
                                    focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Desar configuraci√≥
                    </button>
                </form>
            </div>
        </div>

        <!-- Av√≠s API no configurada -->
        <div id="avis-api" class="hidden bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 dark:text-yellow-200">
                        Necessites configurar la teva clau API d'OpenAI per utilitzar l'aplicaci√≥.
                        <button id="configura-api" class="font-medium underline ml-1 focus:outline-none">
                            Configurar ara
                        </button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Aplicaci√≥ principal -->
        <div id="app-principal">
            <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="idioma-origen" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Idioma original
                        </label>
                        <select id="idioma-origen" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                        bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                        focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="ca">Catal√†</option>
                            <option value="es">Castell√†</option>
                            <option value="en">Angl√®s</option>
                            <option value="fr">Franc√®s</option>
                            <option value="de">Alemany</option>
                            <option value="it">Itali√†</option>
                            <option value="pt">Portugu√®s</option>
                            <option value="nl">Holand√®s</option>
                            <option value="ru">Rus</option>
                            <option value="ja">Japon√®s</option>
                            <option value="zh">Xin√®s</option>
                        </select>
                    </div>
                    <div>
                        <label for="idioma-desti" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Idioma tradu√Øt
                        </label>
                        <select id="idioma-desti" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                        bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                        focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="en">Angl√®s</option>
                            <option value="es">Castell√†</option>
                            <option value="ca">Catal√†</option>
                            <option value="fr">Franc√®s</option>
                            <option value="de">Alemany</option>
                            <option value="it">Itali√†</option>
                            <option value="pt">Portugu√®s</option>
                            <option value="nl">Holand√®s</option>
                            <option value="ru">Rus</option>
                            <option value="ja">Japon√®s</option>
                            <option value="zh">Xin√®s</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6 text-center">
                    <!-- Modificaci√≥: Afegir botons per alternar entre modes -->
                    <div class="flex justify-center mb-4">
                        <div class="inline-flex rounded-md" role="group">
                            <button id="mode-microfon" type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-l-lg hover:bg-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:bg-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                                </svg>
                                Micr√≤fon
                            </button>
                            <button id="mode-text" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                                Text
                            </button>
                        </div>
                    </div>

                    <!-- Contingut del mode micr√≤fon - inicialment visible -->
                    <!-- <div id="contingut-microfon">
                        <div class="text-center mb-6">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                Quan facis clic, el navegador et demanar√† perm√≠s per accedir al micr√≤fon
                            </p>
                            <button id="boto-gravacio" 
                                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full 
                                            transition-colors duration-200 relative">
                                <span id="estat-gravacio">Comen√ßar gravaci√≥</span>
                                <span id="indicador-gravacio" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-600 rounded-full animate-pulse"></span>
                            </button>
                            <div id="temporitzador-gravacio" class="hidden text-sm text-gray-600 dark:text-gray-400 mt-1">
                                Temps: <span id="temps-gravacio">00:00</span>
                            </div>
                        </div>


                    </div> -->
                    <!-- Modificaci√≥: Contenidor amb bot√≥ de gravaci√≥ i cancel¬∑laci√≥ -->
                    <div id="contingut-microfon">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            Quan facis clic, el navegador et demanar√† perm√≠s per accedir al micr√≤fon
                        </p>
                        <div class="flex justify-center space-x-3">
                            <button id="boto-gravacio" 
                                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full 
                                            transition-colors duration-200 relative mb-1">
                                <span id="estat-gravacio">Comen√ßar gravaci√≥</span>
                                <span id="indicador-gravacio" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-600 rounded-full animate-pulse"></span>
                            </button>
                            <!-- Bot√≥ de cancel¬∑laci√≥ - inicialment ocult -->
                            <button id="boto-cancelar" 
                                    class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full 
                                            transition-colors duration-200 mb-1">
                                Cancel¬∑lar
                            </button>
                        </div>
                        <!-- Temporitzador de gravaci√≥ -->
                        <div id="temporitzador-gravacio" class="hidden text-sm text-gray-600 dark:text-gray-400 mt-1">
                            Temps: <span id="temps-gravacio">00:00</span>
                        </div>
                    </div>

                    <!-- Contingut del mode text - inicialment ocult -->
                    <div id="contingut-text" class="hidden">
                        <div class="max-w-lg mx-auto">
                            <textarea id="entrada-text" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                            focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Escriu el text que vols traduir..."
                                    rows="4"></textarea>
                            <button id="boto-traduir-text" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded
                                        transition-colors duration-200">
                                Traduir i generar √†udio
                            </button>
                        </div>
                    </div>

                    <!-- Indicador d'estat - inicialment ocult -->
                    <div id="estat-traduccio" class="hidden text-center mb-4">
                        <div class="flex flex-col items-center justify-center">
                            <div id="loader-traduccio" class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                            <p class="text-gray-600 dark:text-gray-400" id="missatge-estat">Processant traducci√≥...</p>
                        </div>
                    </div>

                    <div id="reproductor-audio" class="hidden mb-6 mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-lg font-semibold mb-0 text-gray-800 dark:text-white">√Äudio original</h3>
                                <button id="descarregar-audio-original" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                                <audio id="audio-original" controls class="w-full"></audio>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-0 text-gray-800 dark:text-white">√Äudio tradu√Øt</h3>
                                <button id="descarregar-audio-traduit" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                                <audio id="audio-reproductor" controls class="w-full"></audio>
                            </div>
                        </div>
                    </div>
                    
                    <div id="textos-traduccio" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">Transcripci√≥ original</h4>
                                <div id="text-transcripcio" class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-gray-800 dark:text-gray-200 text-sm"></div>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">Traducci√≥</h4>
                                <div id="text-traduccio" class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-gray-800 dark:text-gray-200 text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="historial" class="mt-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Historial de traduccions</h3>
                    <div id="llista-historial" class="space-y-4"></div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        // Classe per gestionar l'√†udio
        class GestorAudio {
            constructor() {
                this.gravant = false;
                this.cancelar = false;
                this.botoGravacio = document.getElementById('boto-gravacio');
                this.estatGravacio = document.getElementById('estat-gravacio');
                this.indicadorGravacio = document.getElementById('indicador-gravacio');
                this.botoCancelar = document.getElementById('boto-cancelar'); // Nou
                this.mediaRecorder = null;
                this.chunksAudio = [];

                // Propietats per al temporitzador (afegit nou)
                this.tempsTotalGravacio = 0;
                this.intervalTemporitzador = null;
                this.elementTempsGravacio = document.getElementById('temps-gravacio');
                this.contenidorTemporitzador = document.getElementById('temporitzador-gravacio');
                            
                this.comprovarSuportMicrofon();
                this.botoGravacio.addEventListener('click', () => this.alternarGravacio());
                this.botoCancelar.addEventListener('click', () => this.cancelarGravacio()); // Nou
            }
            
            comprovarSuportMicrofon() {
                // Comprovar si el navegador suporta getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.botoGravacio.disabled = true;
                    this.estatGravacio.textContent = 'Navegador no compatible';
                    alert('El teu navegador no suporta l\'acc√©s al micr√≤fon. Prova amb Chrome, Firefox o Safari.');
                }
            }

            // Afegeix aquests nous m√®todes a la classe GestorAudio
            iniciarTemporitzador() {
                this.tempsTotalGravacio = 0;
                this.actualitzarVisualitzacioTemps();
                this.contenidorTemporitzador.classList.remove('hidden');
                
                this.intervalTemporitzador = setInterval(() => {
                    this.tempsTotalGravacio += 1;
                    this.actualitzarVisualitzacioTemps();
                }, 1000);
            }

            aturarTemporitzador() {
                if (this.intervalTemporitzador) {
                    clearInterval(this.intervalTemporitzador);
                    this.intervalTemporitzador = null;
                }
                this.contenidorTemporitzador.classList.add('hidden');
            }

            actualitzarVisualitzacioTemps() {
                const minuts = Math.floor(this.tempsTotalGravacio / 60);
                const segons = this.tempsTotalGravacio % 60;
                this.elementTempsGravacio.textContent = `${minuts.toString().padStart(2, '0')}:${segons.toString().padStart(2, '0')}`;
            }
            
            async alternarGravacio() {
                if (!this.gravant) {
                    await this.iniciarGravacio();
                } else {
                    this.aturarGravacio();
                }
            }

            cancelarGravacio() {
                if (this.mediaRecorder && this.gravant) {
                    // Aturar el mediaRecorder sense processar l'√†udio
                    this.mediaRecorder.stop();
                    
                    // Netejar els chunks d'√†udio perqu√® no es processin
                    this.chunksAudio = [];
                    
                    // Actualitzar l'estat i la UI
                    this.gravant = false;
                    this.cancelar = true; // Afegit per indicar que la gravaci√≥ ha estat cancel¬∑lada
                    this.actualitzarUI(false);
                    
                    // Aturar el temporitzador (si l'has implementat)
                    if (typeof this.aturarTemporitzador === 'function') {
                        this.aturarTemporitzador();
                    }
                    
                    console.log('Gravaci√≥ cancel¬∑lada per l\'usuari');
                }
            }
            
            async iniciarGravacio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    this.chunksAudio = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.chunksAudio.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.chunksAudio, { type: 'audio/webm' });
                        console.log('Blob d\'√†udio creat, mida:', blob.size, 'tipus:', blob.type);
                        this.enviarAudio(blob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.mediaRecorder.start();
                    this.gravant = true;
                    this.cancelar = false;
                    this.actualitzarUI(true);
                    
                    // Iniciar el temporitzador (afegit nou)
                    this.iniciarTemporitzador();
                } catch (error) {
                    console.error('Error en accedir al micr√≤fon:', error);
                    
                    let missatgeError = 'No s\'ha pogut accedir al micr√≤fon.';
                    
                    if (error.name === 'NotAllowedError') {
                        missatgeError += '\n\nHas denegat el perm√≠s al micr√≤fon. Per activar-lo:\n' +
                                        '1. Fes clic a la icona del cadenat a la barra d\'adreces\n' +
                                        '2. Canvia el perm√≠s del micr√≤fon a "Permet"\n' +
                                        '3. Recarrega la p√†gina';
                    } else if (error.name === 'NotFoundError') {
                        missatgeError += '\n\nNo s\'ha trobat cap micr√≤fon. Assegura\'t que en tens un connectat.';
                    } else if (error.name === 'NotReadableError') {
                        missatgeError += '\n\nEl micr√≤fon est√† sent utilitzat per una altra aplicaci√≥.';
                    }
                    
                    alert(missatgeError);
                }
            }
            
            aturarGravacio() {
                if (this.mediaRecorder && this.gravant) {
                    this.mediaRecorder.stop();
                    this.gravant = false;
                    this.actualitzarUI(false);

                    // Aturar el temporitzador (afegit nou)
                    this.aturarTemporitzador();
                }
            }
            
            actualitzarUI(gravant) {
                if (gravant) {
                    this.estatGravacio.textContent = 'Aturar gravaci√≥';
                    this.botoGravacio.classList.remove('bg-red-500', 'hover:bg-red-600');
                    this.botoGravacio.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    this.indicadorGravacio.classList.remove('hidden');
                    this.botoCancelar.classList.remove('hidden'); // Mostrem el bot√≥ de cancel¬∑laci√≥
                } else {
                    this.estatGravacio.textContent = 'Comen√ßar gravaci√≥';
                    this.botoGravacio.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    this.botoGravacio.classList.add('bg-red-500', 'hover:bg-red-600');
                    this.indicadorGravacio.classList.add('hidden');
                    this.botoCancelar.classList.add('hidden'); // Ocultem el bot√≥ de cancel¬∑laci√≥
                }
            }
            
            enviarAudio(blob) {
                // Aquest m√®tode ser√† cridat des de l'aplicaci√≥ principal
                // this.onAudioEnregistrat?.(blob);
                // Si hi ha chunks d'√†udio, cridem el callback
                if (!this.cancelar){
                    if (this.chunksAudio.length > 0 && blob.size > 0) {
                        this.onAudioEnregistrat?.(blob);
                    } else {
                        console.log('Gravaci√≥ buida, no s\'envia');
                    }
                } else {
                    console.log('Gravaci√≥ cancel¬∑lada o buida, no s\'envia');
                }
                this.cancelar = false; // Reiniciem la variable de cancel¬∑laci√≥
            }
            
            setOnAudioEnregistrat(callback) {
                this.onAudioEnregistrat = callback;
            }
        }

        // Classe per gestionar l'API d'OpenAI
        class GestorOpenAI {
            constructor() {
                this.apiKey = localStorage.getItem('openai-api-key') || '';
                this.veuOriginal = localStorage.getItem('veu-original') || 'alloy';
                this.veuTraduida = localStorage.getItem('veu-traduida') || 'nova';
            }

            isConfigured() {
                return !!this.apiKey;
            }

            setApiKey(apiKey) {
                this.apiKey = apiKey;
                localStorage.setItem('openai-api-key', apiKey);
            }

            getApiKey() {
                return this.apiKey;
            }
            // Afegeix aquests nous m√®todes a la classe GestorOpenAI
            setVeuOriginal(veu) {
                this.veuOriginal = veu;
                localStorage.setItem('veu-original', veu);
            }

            getVeuOriginal() {
                return this.veuOriginal;
            }

            setVeuTraduida(veu) {
                this.veuTraduida = veu;
                localStorage.setItem('veu-traduida', veu);
            }

            getVeuTraduida() {
                return this.veuTraduida;
            }

            async transcriureAudio(audioBlob) {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');
                formData.append('response_format', 'text');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en transcriure √†udio: ${error.error?.message || response.statusText}`);
                }

                const text = await response.text();
                return text;
            }

            async traduirText(text, idiomaOrigen, idiomaDesti) {
                const idiomaOrigenNom = this.getNomIdioma(idiomaOrigen);
                const idiomaDestiNom = this.getNomIdioma(idiomaDesti);

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a professional translator. Translate the following text from ${idiomaOrigenNom} to ${idiomaDestiNom}. Only return the translation, nothing else.`
                            },
                            {
                                role: 'user',
                                content: text
                            }
                        ],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en traduir text: ${error.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async textAAudio(text, idioma) {
                // Seleccionar la veu segons l'idioma
                // let veu = 'alloy'; // veu per defecte
                
                // switch (idioma) {
                //     case 'es':
                //         veu = 'nova';
                //         break;
                //     case 'en':
                //         veu = 'echo';
                //         break;
                //     case 'fr':
                //         veu = 'shimmer';
                //         break;
                //     case 'de':
                //         veu = 'onyx';
                //         break;
                //     case 'ca':
                //         veu = 'alloy';
                //         break;
                // }

                const veu = this.veuTraduida;

                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1',
                        voice: veu,
                        input: text
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en convertir text a √†udio: ${error.error?.message || response.statusText}`);
                }

                const audioBlob = await response.blob();
                return audioBlob;
            }

            getNomIdioma(codi) {
                const mapaCodisIdiomes = {
                    'ca': 'catalan',
                    'es': 'spanish',
                    'en': 'english',
                    'fr': 'french',
                    'de': 'german',
                    'it': 'italian',
                    'pt': 'portuguese',
                    'nl': 'dutch',
                    'ru': 'russian',
                    'ja': 'japanese',
                    'zh': 'chinese'
                };
                return mapaCodisIdiomes[codi] || codi;
            }

            async generarAudioOriginal(text, idioma) {
                // Seleccionar la veu segons l'idioma (igual que al m√®tode textAAudio)
                // let veu = 'alloy'; // veu per defecte
                const veu = this.veuOriginal;
                
                // switch (idioma) {
                //     case 'es':
                //         veu = 'nova';
                //         break;
                //     case 'en':
                //         veu = 'echo';
                //         break;
                //     case 'fr':
                //         veu = 'shimmer';
                //         break;
                //     case 'de':
                //         veu = 'onyx';
                //         break;
                //     case 'ca':
                //         veu = 'alloy';
                //         break;
                // }

                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1',
                        voice: veu,
                        input: text
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en convertir text a √†udio original: ${error.error?.message || response.statusText}`);
                }

                const audioBlob = await response.blob();
                return audioBlob;
            }
        }

        // Classe principal de l'aplicaci√≥
        class AplicacioTraductor {
            constructor() {
                this.gestorAudio = new GestorAudio();
                this.gestorOpenAI = new GestorOpenAI();
                
                // Variables per emmagatzemar la transcripci√≥ i traducci√≥
                this.ultimaTranscripcio = '';
                this.ultimaTraduccio = '';

                // Variables per emmagatzemar els blobs d'√†udio (afegit nou)
                this.ultimAudioOriginal = null;
                this.ultimAudioTraduit = null;
                
                this.inicialitzar();
            }
            
            inicialitzar() {

                // Comprovar si l'API est√† configurada
                this.comprovarConfiguracio();
                
                // Configurar elements de la UI
                this.configUiElements();
                
                // Configurar callback d'√†udio
                this.gestorAudio.setOnAudioEnregistrat((blob) => {
                    this.processarAudio(blob);
                });
                // Configurar el canvi de mode (afegit nou)
                // this.configurarModes();
                // Configurar el canvi de mode (si has afegit aquesta funcionalitat)
                if (typeof this.configurarModes === 'function') {
                    this.configurarModes();
                }
                
                // Configurar botons de desc√†rrega (afegit nou)
                this.configurarBotonsDescarrega();

            }
            
            comprovarConfiguracio() {
                const avisApi = document.getElementById('avis-api');
                
                if (!this.gestorOpenAI.isConfigured()) {
                    avisApi.classList.remove('hidden');
                } else {
                    avisApi.classList.add('hidden');
                }
            }
            
            configUiElements() {
                // Bot√≥ de configuraci√≥
                const botoConfig = document.getElementById('boto-configuracio');
                const modalConfig = document.getElementById('modal-configuracio');
                const tancaModal = document.getElementById('tanca-modal');
                const tancaConfig = document.getElementById('tanca-configuracio');
                const configuraApi = document.getElementById('configura-api');
                
                botoConfig.addEventListener('click', () => {
                    this.mostrarModalConfiguracio();
                });
                
                tancaModal.addEventListener('click', () => {
                    modalConfig.classList.add('hidden');
                });
                
                tancaConfig.addEventListener('click', () => {
                    modalConfig.classList.add('hidden');
                });
                
                configuraApi.addEventListener('click', () => {
                    this.mostrarModalConfiguracio();
                });
                
                // Formulari API
                const formApi = document.getElementById('form-api');
                const apiKeyInput = document.getElementById('api-key');
                const mostrarApiKey = document.getElementById('mostrar-api-key');
                const veuOriginalSelect = document.getElementById('veu-original');
                const veuTraduida = document.getElementById('veu-traduida');
                
                // Carregar la clau API si existeix
                apiKeyInput.value = this.gestorOpenAI.getApiKey();

                // Carregar les veus configurades
                veuOriginalSelect.value = this.gestorOpenAI.getVeuOriginal();
                veuTraduida.value = this.gestorOpenAI.getVeuTraduida();
                
                formApi.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.gestorOpenAI.setApiKey(apiKeyInput.value);
                    this.gestorOpenAI.setVeuOriginal(veuOriginalSelect.value);
                    this.gestorOpenAI.setVeuTraduida(veuTraduida.value);
                    modalConfig.classList.add('hidden');
                    this.comprovarConfiguracio();
                });
                
                mostrarApiKey.addEventListener('change', (e) => {
                    apiKeyInput.type = e.target.checked ? 'text' : 'password';
                });
                
                // Assegurar-nos que l'indicador d'estat est√† ocult a l'inici
                const estatTraduccio = document.getElementById('estat-traduccio');
                estatTraduccio.classList.add('hidden');
            }
            
            mostrarModalConfiguracio() {
                const modalConfig = document.getElementById('modal-configuracio');
                modalConfig.classList.remove('hidden');
            }
            
            async processarAudio(blob) {

                if (!this.gestorOpenAI.isConfigured()) {
                    alert('Cal configurar la clau API d\'OpenAI primer.');
                    this.mostrarModalConfiguracio();
                    return;
                }

                try {
                    // Guardar l'√†udio original
                    const audioOriginal = blob;
                    
                    // Mostrar el loader de c√†rrega
                    this.mostrarEstatProcessant('Transcrivint √†udio...');
                    
                    // 1. Transcriure √†udio original a text
                    const transcripcio = await this.gestorOpenAI.transcriureAudio(blob);
                    console.log('Transcripci√≥:', transcripcio);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Traduint text...');
                    
                    // 2. Traduir el text a l'idioma dest√≠
                    const idiomaOrigen = document.getElementById('idioma-origen').value;
                    const idiomaDesti = document.getElementById('idioma-desti').value;
                    const traduccio = await this.gestorOpenAI.traduirText(transcripcio, idiomaOrigen, idiomaDesti);
                    console.log('Traducci√≥:', traduccio);
                    
                    // Mostrar textos
                    this.mostrarTextos(transcripcio, traduccio);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Generant √†udio...');
                    
                    // 3. Convertir la traducci√≥ a √†udio
                    const audioTraduit = await this.gestorOpenAI.textAAudio(traduccio, idiomaDesti);
                    
                    // Reproduir √†udio tradu√Øt i original
                    this.reproduirAudios(audioOriginal, audioTraduit);
                } catch (error) {
                    console.error('Error en el proc√©s de traducci√≥:', error);
                    const missatgeError = error.message || 'Error en processar l\'√†udio';
                    
                    const estatTraduccio = document.getElementById('estat-traduccio');
                    const missatgeEstat = document.getElementById('missatge-estat');
                    
                    missatgeEstat.textContent = missatgeError;
                    
                    // Canviar l'estil del loader per indicar error
                    const loader = document.getElementById('loader-traduccio');
                    loader.classList.remove('border-blue-500', 'animate-spin');
                    loader.classList.add('border-red-500');
                    
                    setTimeout(() => {
                        estatTraduccio.classList.add('hidden');
                        // Restablir el loader
                        loader.classList.remove('border-red-500');
                        loader.classList.add('border-blue-500', 'animate-spin');
                    }, 5000);
                }
            }
            
            mostrarEstatProcessant(missatge) {
                const estatTraduccio = document.getElementById('estat-traduccio');
                const missatgeEstat = document.getElementById('missatge-estat');
                
                estatTraduccio.classList.remove('hidden');
                missatgeEstat.textContent = missatge;
            }
            
            mostrarTextos(transcripcio, traduccio) {
                this.ultimaTranscripcio = transcripcio;
                this.ultimaTraduccio = traduccio;
                
                const contenidorTextos = document.getElementById('textos-traduccio');
                contenidorTextos.classList.remove('hidden');
                
                const contenidorTranscripcio = document.getElementById('text-transcripcio');
                const contenidorTraduccio = document.getElementById('text-traduccio');
                
                contenidorTranscripcio.textContent = transcripcio;
                contenidorTraduccio.textContent = traduccio;
            }
            
            reproduirAudioTraduit(blob) {
                // Ocultar l'indicador de c√†rrega
                const estatTraduccio = document.getElementById('estat-traduccio');
                estatTraduccio.classList.add('hidden');
                
                const reproductorAudio = document.getElementById('reproductor-audio');
                const audio = document.getElementById('audio-reproductor');
                
                const url = URL.createObjectURL(blob);
                audio.src = url;
                reproductorAudio.classList.remove('hidden');
                audio.play();
                
                // Afegir a l'historial (utilitza la √∫ltima transcripci√≥ i traducci√≥ guardades)
                this.afegirAHistorial(blob, this.ultimaTranscripcio, this.ultimaTraduccio);
                
                // Restablir valors per la seg√ºent traducci√≥
                this.ultimaTranscripcio = '';
                this.ultimaTraduccio = '';
            }
            
            
            // Modifica el m√®tode afegirAHistorial per afegir botons de desc√†rrega a l'historial
            afegirAHistorial(audioBlobOriginal, audioBlobTraduit, transcripcio, traduccio) {
                const llistaHistorial = document.getElementById('llista-historial');
                const element = document.createElement('div');
                element.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4';
                
                const dataActual = new Date().toLocaleString('ca-ES');
                const idiomaOrigen = document.getElementById('idioma-origen').selectedOptions[0].text;
                const idiomaDesti = document.getElementById('idioma-desti').selectedOptions[0].text;
                
                const audioUrlOriginal = URL.createObjectURL(audioBlobOriginal);
                const audioUrlTraduit = URL.createObjectURL(audioBlobTraduit);
                
                // Generar noms d'arxiu √∫nics per a la desc√†rrega
                const timestamp = new Date().getTime();
                const nomArxiuOriginal = `audio_original_${idiomaOrigen.toLowerCase()}_${timestamp}.mp3`;
                const nomArxiuTraduit = `audio_traduit_${idiomaDesti.toLowerCase()}_${timestamp}.mp3`;
                
                element.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-3">
                        <div>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${dataActual}</span>
                            <span class="ml-2 text-sm font-medium text-gray-800 dark:text-white">
                                ${idiomaOrigen} ‚Üí ${idiomaDesti}
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">√Äudio original:</span>
                                <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm flex items-center descarregar-historial" 
                                        data-url="${audioUrlOriginal}" 
                                        data-nom="${nomArxiuOriginal}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                            </div>
                            <audio controls class="w-full mt-1">
                                <source src="${audioUrlOriginal}" type="audio/mp3">
                                El teu navegador no suporta l'element d'√†udio.
                            </audio>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">√Äudio tradu√Øt:</span>
                                <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm flex items-center descarregar-historial" 
                                        data-url="${audioUrlTraduit}" 
                                        data-nom="${nomArxiuTraduit}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                            </div>
                            <audio controls class="w-full mt-1">
                                <source src="${audioUrlTraduit}" type="audio/mp3">
                                El teu navegador no suporta l'element d'√†udio.
                            </audio>
                        </div>
                    </div>
                    <div class="text-sm border-t border-gray-200 dark:border-gray-600 pt-2">
                        <div class="mb-2">
                            <span class="font-medium text-gray-700 dark:text-gray-300">Transcripci√≥:</span>
                            <p class="text-gray-800 dark:text-gray-200">${transcripcio}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700 dark:text-gray-300">Traducci√≥:</span>
                            <p class="text-gray-800 dark:text-gray-200">${traduccio}</p>
                        </div>
                    </div>
                `;
                
                llistaHistorial.insertBefore(element, llistaHistorial.firstChild);
                
                // Configurar els botons de desc√†rrega de l'historial
                const botonsDescarrega = element.querySelectorAll('.descarregar-historial');
                botonsDescarrega.forEach(boto => {
                    boto.addEventListener('click', () => {
                        const url = boto.getAttribute('data-url');
                        const nomArxiu = boto.getAttribute('data-nom');
                        
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = nomArxiu;
                        document.body.appendChild(a);
                        a.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(a);
                        }, 100);
                    });
                });
                
                // Netejar URL objects antics per evitar fuites de mem√≤ria
                if (llistaHistorial.children.length > 5) {
                    for (let i = 5; i < llistaHistorial.children.length; i++) {
                        const audioElements = llistaHistorial.children[i].querySelectorAll('audio');
                        audioElements.forEach(audioElement => {
                            if (audioElement && audioElement.src) {
                                URL.revokeObjectURL(audioElement.src);
                            }
                        });
                        llistaHistorial.removeChild(llistaHistorial.children[i]);
                    }
                }
            }

            configurarModes() {
                // Elements de la UI
                const botoModeMicrofon = document.getElementById('mode-microfon');
                const botoModeText = document.getElementById('mode-text');
                const contingutMicrofon = document.getElementById('contingut-microfon');
                const contingutText = document.getElementById('contingut-text');
                const botoTraduirText = document.getElementById('boto-traduir-text');
                
                // Esdeveniments per canviar mode
                botoModeMicrofon.addEventListener('click', () => {
                    this.canviarMode('microfon');
                });
                
                botoModeText.addEventListener('click', () => {
                    this.canviarMode('text');
                });
                
                // Configurar event per traduir text
                botoTraduirText.addEventListener('click', () => {
                    const text = document.getElementById('entrada-text').value.trim();
                    if (text) {
                        this.processarTextDirecte(text);
                    } else {
                        alert('Si us plau, introdueix algun text per traduir.');
                    }
                });
            }

            canviarMode(mode) {
                const botoModeMicrofon = document.getElementById('mode-microfon');
                const botoModeText = document.getElementById('mode-text');
                const contingutMicrofon = document.getElementById('contingut-microfon');
                const contingutText = document.getElementById('contingut-text');
                
                if (mode === 'microfon') {
                    // Activar mode micr√≤fon
                    botoModeMicrofon.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                    botoModeMicrofon.classList.add('bg-blue-600', 'text-white');
                    
                    botoModeText.classList.remove('bg-blue-600', 'text-white');
                    botoModeText.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white');
                    
                    contingutMicrofon.classList.remove('hidden');
                    contingutText.classList.add('hidden');
                } else if (mode === 'text') {
                    // Activar mode text
                    botoModeMicrofon.classList.remove('bg-blue-600', 'text-white');
                    botoModeMicrofon.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white');
                    
                    botoModeText.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                    botoModeText.classList.add('bg-blue-600', 'text-white');
                    
                    contingutMicrofon.classList.add('hidden');
                    contingutText.classList.remove('hidden');
                    
                    // Si estava gravant, aturar la gravaci√≥
                    if (this.gestorAudio.gravant) {
                        this.gestorAudio.aturarGravacio();
                    }
                }
            }

            async processarTextDirecte(text) {
                if (!this.gestorOpenAI.isConfigured()) {
                    alert('Cal configurar la clau API d\'OpenAI primer.');
                    this.mostrarModalConfiguracio();
                    return;
                }

                try {
                    // Mostrar el loader de c√†rrega
                    this.mostrarEstatProcessant('Generant √†udio original...');
                    
                    // Guardar la transcripci√≥ (en aquest cas, el text introdu√Øt)
                    this.ultimaTranscripcio = text;
                    
                    // Generar √†udio a partir del text original
                    const idiomaOrigen = document.getElementById('idioma-origen').value;
                    const audioOriginal = await this.gestorOpenAI.generarAudioOriginal(text, idiomaOrigen);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Traduint text...');
                    
                    // Traduir el text a l'idioma dest√≠
                    const idiomaDesti = document.getElementById('idioma-desti').value;
                    const traduccio = await this.gestorOpenAI.traduirText(text, idiomaOrigen, idiomaDesti);
                    console.log('Traducci√≥:', traduccio);
                    
                    // Guardar la traducci√≥
                    this.ultimaTraduccio = traduccio;
                    
                    // Mostrar textos
                    this.mostrarTextos(text, traduccio);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Generant √†udio tradu√Øt...');
                    
                    // Convertir la traducci√≥ a √†udio
                    const audioTraduit = await this.gestorOpenAI.textAAudio(traduccio, idiomaDesti);
                    
                    // Reproduir √†udio tradu√Øt i original
                    this.reproduirAudios(audioOriginal, audioTraduit);
                } catch (error) {
                    console.error('Error en el proc√©s de traducci√≥:', error);
                    const missatgeError = error.message || 'Error en processar el text';
                    
                    const estatTraduccio = document.getElementById('estat-traduccio');
                    const missatgeEstat = document.getElementById('missatge-estat');
                    
                    missatgeEstat.textContent = missatgeError;
                    
                    // Canviar l'estil del loader per indicar error
                    const loader = document.getElementById('loader-traduccio');
                    loader.classList.remove('border-blue-500', 'animate-spin');
                    loader.classList.add('border-red-500');
                    
                    setTimeout(() => {
                        estatTraduccio.classList.add('hidden');
                        // Restablir el loader
                        loader.classList.remove('border-red-500');
                        loader.classList.add('border-blue-500', 'animate-spin');
                    }, 5000);
                }
            }

            reproduirAudios(blobOriginal, blobTraduit) {
                // Ocultar l'indicador de c√†rrega
                const estatTraduccio = document.getElementById('estat-traduccio');
                estatTraduccio.classList.add('hidden');
                
                const reproductorAudio = document.getElementById('reproductor-audio');
                const audioOriginal = document.getElementById('audio-original');
                const audioTraduit = document.getElementById('audio-reproductor');

                // Guardar els blobs d'√†udio per a la possible desc√†rrega
                this.ultimAudioOriginal = blobOriginal;
                this.ultimAudioTraduit = blobTraduit;
                
                // Configurar l'√†udio original
                const urlOriginal = URL.createObjectURL(blobOriginal);
                audioOriginal.src = urlOriginal;
                
                // Configurar l'√†udio tradu√Øt
                const urlTraduit = URL.createObjectURL(blobTraduit);
                audioTraduit.src = urlTraduit;
                
                reproductorAudio.classList.remove('hidden');
                audioTraduit.play();
                
                // Afegir a l'historial (utilitza la √∫ltima transcripci√≥ i traducci√≥ guardades)
                this.afegirAHistorial(blobOriginal, blobTraduit, this.ultimaTranscripcio, this.ultimaTraduccio);
                
                // Restablir valors per la seg√ºent traducci√≥
                this.ultimaTranscripcio = '';
                this.ultimaTraduccio = '';
            }

            configurarBotonsDescarrega() {
                const botoDescarregarOriginal = document.getElementById('descarregar-audio-original');
                const botoDescarregarTraduit = document.getElementById('descarregar-audio-traduit');
                
                botoDescarregarOriginal.addEventListener('click', () => {
                    if (this.ultimAudioOriginal) {
                        const idiomaOrigen = document.getElementById('idioma-origen').value;
                        this.descarregarAudio(this.ultimAudioOriginal, `audio_original_${idiomaOrigen}.mp3`);
                    }
                });
                
                botoDescarregarTraduit.addEventListener('click', () => {
                    if (this.ultimAudioTraduit) {
                        const idiomaDesti = document.getElementById('idioma-desti').value;
                        this.descarregarAudio(this.ultimAudioTraduit, `audio_traduit_${idiomaDesti}.mp3`);
                    }
                });
            }

            // Afegeix aquest nou m√®tode a la classe AplicacioTraductor
            descarregarAudio(blob, nomArxiu) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = nomArxiu;
                document.body.appendChild(a);
                a.click();
                
                // Neteja despr√©s de la desc√†rrega
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }

        }

        // Iniciar l'aplicaci√≥
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new AplicacioTraductor();
        });
    </script>
</body>
</html>
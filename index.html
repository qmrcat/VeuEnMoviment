<!DOCTYPE html>
<html lang="ca" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <title>Traductor de Veu en Temps Real - Client Aut√≤nom</title> -->
    <title>Veu en moviment</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./imatges/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./imatges/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./imatges/favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link href="./output.css" rel="stylesheet">
    <style>
        /* Assegurar que les transicions de temes s√≥n suaus */
        html.dark {
            color-scheme: dark;
        }
        
        body, html {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Estils per al loader */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .drop-zone {
            transition: all 0.3s ease;
        }

        .drop-zone.drag-active {
            border-color: #3b82f6 !important; /* blue-500 */
            background-color: #eff6ff !important; /* blue-50 */
        }

        /* Estils per al mode fosc */
        .dark .drop-zone.drag-active {
            border-color: #60a5fa !important; /* blue-400 */
            background-color: #1e3a8a !important; /* blue-900 */
        }
        .zona-imatge {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* Estil per al hover normal */
        .zona-imatge:hover {
            border-color: #93c5fd; /* blue-300 */
            background-color: #eff6ff; /* blue-50 */
        }

        /* Estil per al moment en qu√® s'arrossega una imatge a sobre */
        .zona-imatge.drag-active {
            border-color: #3b82f6 !important; /* blue-500 */
            background-color: #dbeafe !important; /* blue-100 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* blue-500 amb opacitat */
            transform: scale(1.01);
        }

        /* Estils per al mode fosc */
        .dark .zona-imatge:hover {
            border-color: #60a5fa; /* blue-400 */
            background-color: #1e3a8a; /* blue-900 */
        }

        .dark .zona-imatge.drag-active {
            border-color: #60a5fa !important; /* blue-400 */
            background-color: #1e40af !important; /* blue-800 */
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3); /* blue-400 amb opacitat */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-200">
    <div id="app" class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row items-start md:items-center w-full gap-4">
        
                <!-- LOGO -->
                <div class="flex items-center space-x-4 logo">
                    <img src="./imatges/veuenmoviment.png" alt="Example" width="72" height="72">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">
                            Veu en moviment
                        </h1>
                        <h5 class="text-sm font-semibold text-gray-600 mb-0">
                            Traductor de Veu en temps real
                        </h5>
                    </div>
                </div>
        
                <!-- MENU -->
                <div class="flex gap-2 menu mt-2 md:mt-0 md:ml-auto">
                    <button id="tema-toggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white cursor-pointer">
                        <span id="tema-icon">üåô</span>
                    </button>
        
                    <button 
                        id="boto-configuracio"
                        class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white cursor-pointer">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        </header>


        

<!-- Formulari de configuraci√≥ de l'API -->
<div id="modal-configuracio" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <!-- fons semitransparent -->
    <div id="tanca-modal" class="absolute inset-0 bg-black bg-opacity-50"></div>
  
    <!-- contenidor principal -->
    <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md z-10 flex flex-col max-h-[85vh]">
      
      <!-- cap√ßalera fixa -->
      <header class="flex-none p-4 border-b border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Configuraci√≥ API</h2>
          <button id="tanca-configuracio" type="button"
                  class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 
                         cursor-pointer p-2 text-2xl rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
            ‚úï
          </button>
        </div>
      </header>
        
        <!-- CONTINGUT AMB SCROLL - amb al√ßada limitada -->
        <div class="overflow-y-auto flex-grow px-4 py-2">
            <form id="form-api" class="space-y-4">
                <div>
                    <label for="api-key" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Clau API d'OpenAI
                    </label>
                    <input type="password" id="api-key" name="api-key" 
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="mostrar-api-key" class="mr-2">
                        <label for="mostrar-api-key" class="text-sm text-gray-600 dark:text-gray-400">
                            Mostrar clau
                        </label>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mt-3">
                        <p>La clau API es desar√† localment al teu navegador i mai s'enviar√† al nostre servidor.</p>
                        <p class="mt-1">Si no tens una clau API d'OpenAI, pots obtenir-ne una a <a href="https://platform.openai.com/account/api-keys" target="_blank" class="text-blue-500 hover:underline">platform.openai.com</a> requereix un pagament</p>
                        <p class="mt-1">Si vols consulta el consum o saber el cr√®dit que et queda ves a <a href="https://platform.openai.com/usage" target="_blank" class="text-blue-500 hover:underline">platform.openai.com/usage</a></p>
                    </div>                        
                </div>
                
                <!-- Secci√≥ de configuraci√≥ de veus -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <h3 class="text-md font-semibold text-gray-800 dark:text-white mb-3">Configuraci√≥ de veus</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Veu per idioma original -->
                        <div>
                            <label for="veu-original" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Veu original
                            </label>
                            <select id="veu-original" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                <optgroup label="Veus masculines">
                                    <option value="alloy">Alloy</option>
                                    <option value="echo">Echo</option>
                                    <option value="fable">Fable</option>
                                    <option value="onyx">Onyx</option>
                                    <option value="ash">Ash</option>
                                    <option value="balland">Balland</option>
                                    <option value="verse">Verse</option>
                                </optgroup>
                                <optgroup label="Veus femenines">
                                    <option value="nova">Nova</option>
                                    <option value="shimmer">Shimmer</option>
                                    <option value="coral">Coral</option>
                                    <option value="sage">Sage</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- Veu per idioma tradu√Øt -->
                        <div>
                            <label for="veu-traduida" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Veu traducci√≥
                            </label>
                            <select id="veu-traduida" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer" >
                                <optgroup label="Veus masculines">
                                    <option value="alloy">Alloy</option>
                                    <option value="echo">Echo</option>
                                    <option value="fable">Fable</option>
                                    <option value="onyx">Onyx</option>
                                    <option value="ash">Ash</option>
                                    <option value="balland">Balland</option>
                                    <option value="verse">Verse</option>
                                </optgroup>
                                <optgroup label="Veus femenines">
                                    <option value="nova">Nova</option>
                                    <option value="shimmer">Shimmer</option>
                                    <option value="coral">Coral</option>
                                    <option value="sage">Sage</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>                    

                <!-- Secci√≥ de configuraci√≥ d'idiomes -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <h3 class="text-md font-semibold text-gray-800 dark:text-white mb-3">Configuraci√≥ d'idiomes</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- idioma original -->
                        <div>
                            <label for="idioma-original" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Idioma original
                            </label>
                            <select id="idioma-original" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                <option value="">Selecciona...</option> 
                            </select>
                        </div>
                        
                        <!-- Veu per idioma tradu√Øt -->
                        <div>
                            <label for="idioma-traduccio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                               Idioma a tradu√Ør
                            </label>
                            <select id="idioma-traduccio" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                            focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer" >
                                <option value="">Selecciona...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Espai extra al final del scroll -->
                <div class="h-4"></div>
            </form>
        </div>
        
        <!-- PEU FIX AMB BOT√ì DE DESAR -->
        <footer class="flex-none p-4 border-t border-gray-200 dark:border-gray-700">
            <button type="submit" form="form-api"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg
                           focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer text-lg">
              Desar configuraci√≥
            </button>
          </footer>
    </div>
</div>

        <!-- Av√≠s API no configurada -->
        <div id="avis-api" class="hidden bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 dark:text-yellow-200">
                        Necessites configurar la teva clau API d'OpenAI per utilitzar l'aplicaci√≥.
                        <button id="configura-api" class="font-medium underline ml-1 focus:outline-none  cursor-pointer">
                            Configurar ara
                        </button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Aplicaci√≥ principal -->
        <div id="app-principal">
            <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                <div class="flex items-end gap-2 mb-6">
                    <div class="flex-1">
                        <label for="idioma-origen" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Idioma original
                        </label>
                        <select id="idioma-origen" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                        bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            <option value="">Selecciona...</option>                 
                        </select>
                    </div>
                    <div class="flex items-center justify-center">
                        <button id="intercanviar-idiomes" 
                                class="p-2 rounded-full bg-transparent hover:bg-gray-200 dark:bg-transparent dark:hover:bg-gray-600 
                                      border-transparent dark:border-transparent focus:outline-none focus:ring-2 
                                      focus:ring-blue-500 transition-colors duration-200 cursor-pointer">

                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex-1">
                        <label for="idioma-desti" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Idioma tradu√Øt
                        </label>
                        <select id="idioma-desti" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                        bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                        focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            <option value="">Selecciona...</option> 
                        </select>
                    </div>
                </div>
                <div class="mb-6 text-center">
                    <!-- Modificaci√≥: Afegir botons per alternar entre modes -->
                    <!-- <div class="flex justify-center mb-4">
                        <div class="inline-flex rounded-md" role="group">
                            <button id="mode-microfon" type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-l-lg hover:bg-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:bg-blue-700 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                                </svg>
                                Micr√≤fon
                            </button>
                            <button id="mode-text" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                                Text
                            </button>
                        </div>
                    </div> -->
                    <div class="flex justify-center mb-4">
                        <div class="inline-flex rounded-md" role="group">
                            <button id="mode-microfon" type="button" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-l-lg hover:bg-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:bg-blue-700 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                                </svg>
                                Micr√≤fon
                            </button>
                            <button id="mode-text" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border-y border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                                Text
                            </button>
                            <button id="mode-imatge" type="button" class="px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-500 focus:text-blue-700 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:text-white dark:hover:bg-gray-600 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                                </svg>
                                Imatge
                            </button>
                        </div>
                    </div>

                    <!-- Modificaci√≥: Contenidor amb bot√≥ de gravaci√≥ i cancel¬∑laci√≥ -->
                    <div id="contingut-microfon">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            Quan facis clic, el navegador et demanar√† perm√≠s per accedir al micr√≤fon
                        </p>
                        <div class="flex justify-center space-x-3">
                            <button id="boto-gravacio" 
                                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-full 
                                            transition-colors duration-200 relative mb-1 cursor-pointer">
                                <span id="estat-gravacio">Comen√ßar gravaci√≥</span>
                                <span id="indicador-gravacio" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-600 rounded-full animate-pulse"></span>
                            </button>
                            <!-- Bot√≥ de cancel¬∑laci√≥ - inicialment ocult -->
                            <button id="boto-cancelar" 
                                    class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full 
                                            transition-colors duration-200 mb-1 cursor-pointer">
                                Cancel¬∑lar
                            </button>
                        </div>
                        <!-- Temporitzador de gravaci√≥ -->
                        <div id="temporitzador-gravacio" class="hidden text-sm text-gray-600 dark:text-gray-400 mt-1">
                            Temps: <span id="temps-gravacio">00:00</span>
                        </div>
                    </div>

                    <!-- Contingut del mode text - inicialment ocult -->
                    <div id="contingut-text" class="hidden">
                        <div class="max-w-lg mx-auto">
                            <textarea id="entrada-text" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md 
                                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                                            focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Escriu el text que vols traduir..."
                                    rows="4"></textarea>
                            <button id="boto-traduir-text" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded
                                        transition-colors duration-200  cursor-pointer">
                                Traduir i generar √†udio
                            </button>
                        </div>
                    </div>

                    <!-- Contingut del mode imatge - inicialment ocult -->
                    <div id="contingut-imatge" class="hidden">
                        <div class="max-w-lg mx-auto">
                            <div class="mb-4">
                                <div class="flex items-center justify-center w-full">
                                    <label for="entrada-imatge" class="zona-imatge flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg bg-gray-50 dark:hover:bg-gray-700 dark:bg-gray-800 dark:border-gray-600 dark:hover:border-gray-500">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                            <svg class="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Fes clic per pujar</span> o arrossega i deixa anar</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">PNG, JPG o JPEG (MAX. 5MB)</p>
                                        </div>
                                        <input id="entrada-imatge" type="file" class="hidden" accept="image/png, image/jpeg, image/jpg" />
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Previsualitzaci√≥ de la imatge pujada -->
                            <div id="previsualitzacio-imatge" class="hidden mt-4 mb-4">
                                <div class="relative">
                                    <img id="imatge-pujada" class="w-full h-auto rounded-lg" src="#" alt="Imatge pujada" />
                                    <button id="eliminar-imatge" class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 focus:outline-none">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <button id="boto-traduir-imatge" 
                                    class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded
                                        transition-colors duration-200 cursor-pointer hidden">
                                Extreure i traduir text
                            </button>
                        </div>
                    </div>

                    <!-- Indicador d'estat - inicialment ocult -->
                    <div id="estat-traduccio" class="hidden text-center mb-4">
                        <div class="flex flex-col items-center justify-center">
                            <div id="loader-traduccio" class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                            <p class="text-gray-600 dark:text-gray-400" id="missatge-estat">Processant traducci√≥...</p>
                        </div>
                    </div>

                    <!-- Resultats de traducci√≥ d'imatge - inicialment ocult -->
                    <div id="resultats-imatge" class="hidden mt-6 bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800 dark:text-white">Resultats de la traducci√≥</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">Text detectat (original)</h4>
                                <div id="text-imatge-original" class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-gray-800 dark:text-gray-200 text-sm"></div>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">Text tradu√Øt</h4>
                                <div id="text-imatge-traduit" class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-gray-800 dark:text-gray-200 text-sm"></div>
                                
                                <!-- Bot√≥ per convertir a √†udio -->
                                <div class="mt-3 flex items-center space-x-2">
                                    <button id="boto-audio-imatge" class="flex items-center px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded transition-colors duration-200 cursor-pointer">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" />
                                        </svg>
                                        Escoltar traducci√≥
                                    </button>
                                    
                                    <!-- Bot√≥ per descarregar √†udio (inicialment ocult) -->
                                    <button id="descarregar-audio-imatge" class="hidden items-center px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded transition-colors duration-200 cursor-pointer">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Descarregar √†udio
                                    </button>
                                </div>
                                
                                <!-- Reproductor d'√†udio (inicialment ocult) -->
                                <div id="audio-imatge-container" class="mt-3 hidden">
                                    <audio id="audio-imatge-reproductor" controls class="w-full"></audio>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="reproductor-audio" class="hidden mb-6 mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-lg font-semibold mb-0 text-gray-800 dark:text-white">√Äudio original</h3>
                                <button id="descarregar-audio-original" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center  cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                                <audio id="audio-original" controls class="w-full"></audio>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-0 text-gray-800 dark:text-white">√Äudio tradu√Øt</h3>
                                <button id="descarregar-audio-traduit" class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center  cursor-pointer">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                                <audio id="audio-reproductor" controls class="w-full"></audio>
                            </div>
                        </div>
                    </div>
                    
                    <div id="textos-traduccio" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">Transcripci√≥ original</h4>
                                <div id="text-transcripcio" class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-gray-800 dark:text-gray-200 text-sm"></div>
                            </div>
                            <div>
                                <h4 class="text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">Traducci√≥</h4>
                                <div id="text-traduccio" class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-gray-800 dark:text-gray-200 text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="historial" class="mt-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Historial de traduccions</h3>
                    <div id="llista-historial" class="space-y-4"></div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        const idiomesJSON = [
            { "angles": "afrikaans", "catala": "afrikaans", "codi": "af" },
            { "angles": "arabic", "catala": "√†rab", "codi": "ar" },
            { "angles": "armenian", "catala": "armeni", "codi": "hy" },
            { "angles": "azerbaijani", "catala": "azerbaidjan√®s", "codi": "az" },
            { "angles": "belarusian", "catala": "bielor√∫s", "codi": "be" },
            { "angles": "bosnian", "catala": "bosni√†", "codi": "bs" },
            { "angles": "bulgarian", "catala": "b√∫lgar", "codi": "bg" },
            { "angles": "catalan", "catala": "catal√†", "codi": "ca" },
            { "angles": "chinese", "catala": "xin√®s", "codi": "zh" },
            { "angles": "croatian", "catala": "croat", "codi": "hr" },
            { "angles": "czech", "catala": "txec", "codi": "cs" },
            { "angles": "danish", "catala": "dan√®s", "codi": "da" },
            { "angles": "dutch", "catala": "neerland√®s", "codi": "nl" },
            { "angles": "english", "catala": "angl√®s", "codi": "en" },
            { "angles": "estonian", "catala": "estoni√†", "codi": "et" },
            { "angles": "finnish", "catala": "fin√®s", "codi": "fi" },
            { "angles": "french", "catala": "franc√®s", "codi": "fr" },
            { "angles": "galician", "catala": "gallec", "codi": "gl" },
            { "angles": "german", "catala": "alemany", "codi": "de" },
            { "angles": "greek", "catala": "grec", "codi": "el" },
            { "angles": "hebrew", "catala": "hebreu", "codi": "he" },
            { "angles": "hindi", "catala": "hindi", "codi": "hi" },
            { "angles": "hungarian", "catala": "hongar√®s", "codi": "hu" },
            { "angles": "icelandic", "catala": "island√®s", "codi": "is" },
            { "angles": "indonesian", "catala": "indonesi", "codi": "id" },
            { "angles": "italian", "catala": "itali√†", "codi": "it" },
            { "angles": "japanese", "catala": "japon√®s", "codi": "ja" },
            { "angles": "kannada", "catala": "kannada", "codi": "kn" },
            { "angles": "kazakh", "catala": "kazakh", "codi": "kk" },
            { "angles": "korean", "catala": "core√†", "codi": "ko" },
            { "angles": "latvian", "catala": "let√≥", "codi": "lv" },
            { "angles": "lithuanian", "catala": "litu√†", "codi": "lt" },
            { "angles": "macedonian", "catala": "macedoni", "codi": "mk" },
            { "angles": "malay", "catala": "malai", "codi": "ms" },
            { "angles": "marathi", "catala": "marathi", "codi": "mr" },
            { "angles": "maori", "catala": "maori", "codi": "mi" },
            { "angles": "nepali", "catala": "nepal√®s", "codi": "ne" },
            { "angles": "norwegian", "catala": "noruec", "codi": "no" },
            { "angles": "persian", "catala": "persa", "codi": "fa" },
            { "angles": "polish", "catala": "polon√®s", "codi": "pl" },
            { "angles": "portuguese", "catala": "portugu√®s", "codi": "pt" },
            { "angles": "romanian", "catala": "roman√®s", "codi": "ro" },
            { "angles": "russian", "catala": "rus", "codi": "ru" },
            { "angles": "serbian", "catala": "serbi", "codi": "sr" },
            { "angles": "slovak", "catala": "eslovac", "codi": "sk" },
            { "angles": "slovenian", "catala": "eslov√®", "codi": "sl" },
            { "angles": "spanish", "catala": "espanyol", "codi": "es" },
            { "angles": "swahili", "catala": "suahili", "codi": "sw" },
            { "angles": "swedish", "catala": "suec", "codi": "sv" },
            { "angles": "tagalog", "catala": "tagal", "codi": "tl" },
            { "angles": "tamil", "catala": "t√†mil", "codi": "ta" },
            { "angles": "thai", "catala": "tai", "codi": "th" },
            { "angles": "turkish", "catala": "turc", "codi": "tr" },
            { "angles": "ukrainian", "catala": "ucra√Øn√®s", "codi": "uk" },
            { "angles": "urdu", "catala": "urd√∫", "codi": "ur" },
            { "angles": "vietnamese", "catala": "vietnamita", "codi": "vi" },
            { "angles": "welsh", "catala": "gal¬∑l√®s", "codi": "cy" }
        ];



        // Funci√≥ per ordenar un array d'objectes per una columna (alfab√®ticament)
        function ordenarIdiomesPerColumna(array, columna) {
            return [...array].sort((a, b) => {
                const valA = (a[columna] || '').toString().toLowerCase();
                const valB = (b[columna] || '').toString().toLowerCase();
                if (valA < valB) return -1;
                if (valA > valB) return 1;
                return 0;
            });
        }


        function generarOptionsSelect(json, columnaOrdenacio = '') {
            
            let options = '';
            let jsonOrdenat
            if (columnaOrdenacio !== '') {
                jsonOrdenat = ordenarIdiomesPerColumna(json, columnaOrdenacio);
            } else {
                jsonOrdenat = [...json];
            }   

            // Recorrem cada idioma del JSON
            jsonOrdenat.forEach(row => {
                // Constru√Øm cada option amb el format demanat
                options += `<option data-codi="${row.codi}" value="${row.angles}">${row.catala}</option>\n`;
            });
            
            return options;
        }

        /**
         * Funci√≥ que genera i insereix les opcions d'un select HTML a partir d'un JSON d'idiomes
         * @param {string} selectId - ID de l'element select on s'inseriran les opcions
         * @param {Array} options - cadena amb les opcions generades
         * @returns {boolean} Retorna true si s'han inserit correctament, false en cas contrari
         */
        function inserirOptionsSelect(selectId, options) {
            // Obtenim l'element select a partir del seu ID
            const selectElement = document.getElementById(selectId);
            
            // Comprovem que l'element existeixi
            if (!selectElement) {
                console.error(`No s'ha trobat cap element amb l'ID: ${selectId}`);
                return false;
            }
            
            // Inserim les opcions al select
            selectElement.innerHTML = options;
            
            return true;
        }
        

        // Classe per gestionar l'√†udio
        class GestorAudio {
            constructor() {
                this.gravant = false;
                this.cancelar = false;
                this.botoGravacio = document.getElementById('boto-gravacio');
                this.estatGravacio = document.getElementById('estat-gravacio');
                this.indicadorGravacio = document.getElementById('indicador-gravacio');
                this.botoCancelar = document.getElementById('boto-cancelar'); // Nou
                this.mediaRecorder = null;
                this.chunksAudio = [];

                // Propietats per al temporitzador (afegit nou)
                this.tempsTotalGravacio = 0;
                this.intervalTemporitzador = null;
                this.elementTempsGravacio = document.getElementById('temps-gravacio');
                this.contenidorTemporitzador = document.getElementById('temporitzador-gravacio');
                            
                this.comprovarSuportMicrofon();
                this.botoGravacio.addEventListener('click', () => this.alternarGravacio());
                this.botoCancelar.addEventListener('click', () => this.cancelarGravacio()); // Nou
            }
            
            comprovarSuportMicrofon() {
                // Comprovar si el navegador suporta getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.botoGravacio.disabled = true;
                    this.estatGravacio.textContent = 'Navegador no compatible';
                    alert('El teu navegador no suporta l\'acc√©s al micr√≤fon. Prova amb Chrome, Firefox o Safari.');
                }
            }

            // Afegeix aquests nous m√®todes a la classe GestorAudio
            iniciarTemporitzador() {
                this.tempsTotalGravacio = 0;
                this.actualitzarVisualitzacioTemps();
                this.contenidorTemporitzador.classList.remove('hidden');
                
                this.intervalTemporitzador = setInterval(() => {
                    this.tempsTotalGravacio += 1;
                    this.actualitzarVisualitzacioTemps();
                }, 1000);
            }

            aturarTemporitzador() {
                if (this.intervalTemporitzador) {
                    clearInterval(this.intervalTemporitzador);
                    this.intervalTemporitzador = null;
                }
                this.contenidorTemporitzador.classList.add('hidden');
            }

            actualitzarVisualitzacioTemps() {
                const minuts = Math.floor(this.tempsTotalGravacio / 60);
                const segons = this.tempsTotalGravacio % 60;
                this.elementTempsGravacio.textContent = `${minuts.toString().padStart(2, '0')}:${segons.toString().padStart(2, '0')}`;
            }
            
            async alternarGravacio() {
                if (!this.gravant) {
                    await this.iniciarGravacio();
                } else {
                    this.aturarGravacio();
                }
            }

            cancelarGravacio() {
                if (this.mediaRecorder && this.gravant) {
                    // Aturar el mediaRecorder sense processar l'√†udio
                    this.mediaRecorder.stop();
                    
                    // Netejar els chunks d'√†udio perqu√® no es processin
                    this.chunksAudio = [];
                    
                    // Actualitzar l'estat i la UI
                    this.gravant = false;
                    this.cancelar = true; // Afegit per indicar que la gravaci√≥ ha estat cancel¬∑lada
                    this.actualitzarUI(false);
                    
                    // Aturar el temporitzador (si l'has implementat)
                    if (typeof this.aturarTemporitzador === 'function') {
                        this.aturarTemporitzador();
                    }
                    
                    console.log('Gravaci√≥ cancel¬∑lada per l\'usuari');
                }
            }
            
            async iniciarGravacio() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    this.chunksAudio = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.chunksAudio.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.chunksAudio, { type: 'audio/webm' });
                        console.log('Blob d\'√†udio creat, mida:', blob.size, 'tipus:', blob.type);
                        this.enviarAudio(blob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    this.mediaRecorder.start();
                    this.gravant = true;
                    this.cancelar = false;
                    this.actualitzarUI(true);
                    
                    // Iniciar el temporitzador (afegit nou)
                    this.iniciarTemporitzador();
                } catch (error) {
                    console.error('Error en accedir al micr√≤fon:', error);
                    
                    let missatgeError = 'No s\'ha pogut accedir al micr√≤fon.';
                    
                    if (error.name === 'NotAllowedError') {
                        missatgeError += '\n\nHas denegat el perm√≠s al micr√≤fon. Per activar-lo:\n' +
                                        '1. Fes clic a la icona del cadenat a la barra d\'adreces\n' +
                                        '2. Canvia el perm√≠s del micr√≤fon a "Permet"\n' +
                                        '3. Recarrega la p√†gina';
                    } else if (error.name === 'NotFoundError') {
                        missatgeError += '\n\nNo s\'ha trobat cap micr√≤fon. Assegura\'t que en tens un connectat.';
                    } else if (error.name === 'NotReadableError') {
                        missatgeError += '\n\nEl micr√≤fon est√† sent utilitzat per una altra aplicaci√≥.';
                    }
                    
                    alert(missatgeError);
                }
            }
            
            aturarGravacio() {
                if (this.mediaRecorder && this.gravant) {
                    this.mediaRecorder.stop();
                    this.gravant = false;
                    this.actualitzarUI(false);

                    // Aturar el temporitzador (afegit nou)
                    this.aturarTemporitzador();
                }
            }
            
            actualitzarUI(gravant) {
                if (gravant) {
                    this.estatGravacio.textContent = 'Aturar gravaci√≥';
                    this.botoGravacio.classList.remove('bg-red-500', 'hover:bg-red-600');
                    this.botoGravacio.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    this.indicadorGravacio.classList.remove('hidden');
                    this.botoCancelar.classList.remove('hidden'); // Mostrem el bot√≥ de cancel¬∑laci√≥
                } else {
                    this.estatGravacio.textContent = 'Comen√ßar gravaci√≥';
                    this.botoGravacio.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    this.botoGravacio.classList.add('bg-red-500', 'hover:bg-red-600');
                    this.indicadorGravacio.classList.add('hidden');
                    this.botoCancelar.classList.add('hidden'); // Ocultem el bot√≥ de cancel¬∑laci√≥
                }
            }
            
            enviarAudio(blob) {
                // Aquest m√®tode ser√† cridat des de l'aplicaci√≥ principal
                // Si hi ha chunks d'√†udio, cridem el callback
                if (!this.cancelar){
                    if (this.chunksAudio.length > 0 && blob.size > 0) {
                        this.onAudioEnregistrat?.(blob);
                    } else {
                        console.log('Gravaci√≥ buida, no s\'envia');
                    }
                } else {
                    console.log('Gravaci√≥ cancel¬∑lada o buida, no s\'envia');
                }
                this.cancelar = false; // Reiniciem la variable de cancel¬∑laci√≥
            }
            
            setOnAudioEnregistrat(callback) {
                this.onAudioEnregistrat = callback;
            }
        }

        // Classe per gestionar l'API d'OpenAI
        class GestorOpenAI {
            constructor() {
                this.apiKey = localStorage.getItem('openai-api-key') || '';
                this.veuOriginal = localStorage.getItem('veu-original') || 'alloy';
                this.veuTraduida = localStorage.getItem('veu-traduida') || 'nova';
                this.idiomaOriginal = localStorage.getItem('idioma-original') || 'Catalan';  // catal√†
                this.idiomaTraduccio = localStorage.getItem('idioma-traduccio') || 'English'; // angl√®s
            }

            isConfigured() {
                return !!this.apiKey;
            }

            setApiKey(apiKey) {
                this.apiKey = apiKey;
                localStorage.setItem('openai-api-key', apiKey);
            }

            getApiKey() {
                return this.apiKey;
            }
            // Afegeix aquests nous m√®todes a la classe GestorOpenAI
            setVeuOriginal(veu) {
                this.veuOriginal = veu;
                localStorage.setItem('veu-original', veu);
            }

            getVeuOriginal() {
                return this.veuOriginal;
            }

            setVeuTraduida(veu) {
                this.veuTraduida = veu;
                localStorage.setItem('veu-traduida', veu);
            }

            getVeuTraduida() {
                return this.veuTraduida;
            }

            ///

            setIdiomaOriginal(idioma) {
                this.idiomaOriginal = idioma;
                localStorage.setItem('idioma-original', idioma);
            }

            getIdiomaOriginal() {
                return this.idiomaOriginal;
            }

            setIdiomaTraduccio(idioma) {
                this.idiomaTraduccio = idioma;
                localStorage.setItem('idioma-traduccio', idioma);
            }

            getIdiomaTraduccio() {
                return this.idiomaTraduccio;
            }
            ///

            getUsApiKeyFacturacio() {
                // no es pot consultar des del navegador, cal fer-ho des del servidor
                return

                // const apiKey = this.getApiKey();
                // if (!apiKey) {
                //     console.error('Clau API no configurada. No es pot consultar l\'√∫s.');
                //     return;
                // }
                // //fetch(`https://api.openai.com/v1/dashboard/billing/usage?start_date=${start}&end_date=${end}`, {
                // fetch('https://api.openai.com/v1/dashboard/billing/credit_grants', {
                //     method: 'GET',
                //     headers: {
                //         'Authorization': `Bearer ${apiKey}`,
                //         'Content-Type': 'application/json'
                //     }
                //     })
                //     .then(res => res.json())
                //     .then(data => {
                //         console.log('Cr√®dit disponible:', data);
                //     const total = data.total_granted;
                //     const usat = data.total_used;
                //     const disponible = data.total_available;

                //     const convert = usd => usd * 0.93; // tipus de canvi aproximat USD ‚Üí EUR

                //     console.log(`Cr√®dit total: $${total.toFixed(2)} (~‚Ç¨${convert(total).toFixed(2)})`);
                //     console.log(`Has gastat: $${usat.toFixed(2)} (~‚Ç¨${convert(usat).toFixed(2)})`);
                //     console.log(`Et queda: $${disponible.toFixed(2)} (~‚Ç¨${convert(disponible).toFixed(2)})`);
                //     })
                //     .catch(err => console.error('Error consultant el cr√®dit:', err));

            }

            async transcriureAudio(audioBlob) {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');
                formData.append('response_format', 'text');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en transcriure √†udio: ${error.error?.message || response.statusText}`);
                }

                const text = await response.text();

                
                return text;
            }

            async traduirText(text, idiomaOrigen, idiomaDesti) {

                const content = `You are a professional translator. Translate the following text from ${idiomaOrigen} to ${idiomaDesti}. Only return the translation, nothing else.`
                // const content = `Ets un traductor professional. Tradu√Øu el seg√ºent text de ${idiomaOrigenNom} a ${idiomaDestiNom}. Torna nom√©s la traducci√≥, res m√©s.`

                console.log("üöÄ ~ traduirText ~ content:", content)

                // Pots utilitzar altres models de OpenAI com: 
                // "gpt-4o", "gpt-4-turbo", "gpt-4", "gpt-3.5-turbo", etc.
                // Consulta https://platform.openai.com/docs/models/overview per la llista actualitzada.
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o', // Pots canviar per "gpt-4o", "gpt-4-turbo", etc.
                        messages: [
                            {
                                role: 'system',
                                content: content
                            },
                            {
                                role: 'user',
                                content: text
                            }
                        ],
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en traduir text: ${error.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            

            async textAAudio(text, idioma) {
                // Seleccionar la veu segons l'idioma

                const veu = this.veuTraduida;

                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1',
                        voice: veu,
                        input: text
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en convertir text a √†udio: ${error.error?.message || response.statusText}`);
                }

                const audioBlob = await response.blob();
                return audioBlob;
            }

            

            async extraureTextImatge(imatgeBase64, idiomaDesti) {
                // Utilitzem l'API de Vision (gpt-4-vision-preview -> gpt-4o) per extreure text d'una imatge
                const idiomaDestiNom = idiomaDesti.value   // this.getNomIdioma(idiomaDesti);
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'Ets un sistema OCR prec√≠s. Extreu i retorna tot el text visible en la imatge sense afegir informaci√≥ addicional. Si no hi ha text visible, indica-ho clarament.'
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Extreu tot el text visible en aquesta imatge. Retorna nom√©s el text extret.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:image/jpeg;base64,${imatgeBase64}`
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en extreure text de la imatge: ${error.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();
            }

            getNomIdioma(codi) { // proximament a eliminar 
                const mapaCodisIdiomes = {
                    'ca': 'catalan',
                    'es': 'spanish',
                    'en': 'english',
                    'fr': 'french',
                    'de': 'german',
                    'it': 'italian',
                    'pt': 'portuguese',
                    'nl': 'dutch',
                    'ru': 'russian',
                    'ja': 'japanese',
                    'zh': 'chinese'
                };
                return mapaCodisIdiomes[codi] || codi;
            }

            async generarAudioOriginal(text, idioma) {
                // Seleccionar la veu segons l'idioma (igual que al m√®tode textAAudio)
                // let veu = 'alloy'; // veu per defecte
                const veu = this.veuOriginal;
                
                // switch (idioma) {
                //     case 'es':
                //         veu = 'nova';
                //         break;
                //     case 'en':
                //         veu = 'echo';
                //         break;
                //     case 'fr':
                //         veu = 'shimmer';
                //         break;
                //     case 'de':
                //         veu = 'onyx';
                //         break;
                //     case 'ca':
                //         veu = 'alloy';
                //         break;
                // }

                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'tts-1',
                        voice: veu,
                        input: text
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error en convertir text a √†udio original: ${error.error?.message || response.statusText}`);
                }

                const audioBlob = await response.blob();
                return audioBlob;
            }
        }

        // Classe principal de l'aplicaci√≥
        class AplicacioTraductor {
            constructor() {
                this.gestorAudio = new GestorAudio();
                this.gestorOpenAI = new GestorOpenAI();
                
                
                // Variables per emmagatzemar la transcripci√≥ i traducci√≥
                this.ultimaTranscripcio = '';
                this.ultimaTraduccio = '';

                // Variables per emmagatzemar els blobs d'√†udio (afegit nou)
                this.ultimAudioOriginal = null;
                this.ultimAudioTraduit = null;

                this.ultimTraduccioImatge = null;
                
                this.inicialitzar();
            }
            
            inicialitzar() {

                // Comprovar si l'API est√† configurada
                this.comprovarConfiguracio();
                
                // Configurar elements de la UI
                this.configUiElements();

                // Configurar el bot√≥ d'intercanvi d'idiomes
                this.configurarBotoIntercanvi();
                
                // Configurar callback d'√†udio
                this.gestorAudio.setOnAudioEnregistrat((blob) => {
                    this.processarAudio(blob);
                });

                // Configurar el canvi de mode (afegit nou)
                // this.configurarModes();
                // Configurar el canvi de mode (si has afegit aquesta funcionalitat)
                if (typeof this.configurarModes === 'function') {
                    this.configurarModes();
                }
                
                // Configurar botons de desc√†rrega (afegit nou)
                this.configurarBotonsDescarrega();

            }
            
            comprovarConfiguracio() {
                const avisApi = document.getElementById('avis-api');
                
                if (!this.gestorOpenAI.isConfigured()) {
                    avisApi.classList.remove('hidden');
                } else {
                    avisApi.classList.add('hidden');
                }
            }
            
            configUiElements() {
                // Bot√≥ de configuraci√≥
                const botoConfig = document.getElementById('boto-configuracio');
                const modalConfig = document.getElementById('modal-configuracio');
                const tancaModal = document.getElementById('tanca-modal');
                const tancaConfig = document.getElementById('tanca-configuracio');
                const configuraApi = document.getElementById('configura-api');
                
                botoConfig.addEventListener('click', () => {
                    this.gestorOpenAI.getUsApiKeyFacturacio()
                    this.mostrarModalConfiguracio();
                });
                
                tancaModal.addEventListener('click', () => {
                    modalConfig.classList.add('hidden');
                });
                
                tancaConfig.addEventListener('click', () => {
                    modalConfig.classList.add('hidden');
                });
                
                configuraApi.addEventListener('click', () => {
                    this.mostrarModalConfiguracio();
                });
                
                // Formulari API
                const formApi = document.getElementById('form-api');
                const apiKeyInput = document.getElementById('api-key');
                const mostrarApiKey = document.getElementById('mostrar-api-key');
                const veuOriginalSelect = document.getElementById('veu-original');
                const veuTraduida = document.getElementById('veu-traduida');

                const idiomaOriginalDef = document.getElementById('idioma-original');
                const idiomaTraduccioDef = document.getElementById('idioma-traduccio');
                
                // Carregar la clau API si existeix
                apiKeyInput.value = this.gestorOpenAI.getApiKey();

                // Carregar les veus configurades
                veuOriginalSelect.value = this.gestorOpenAI.getVeuOriginal();
                veuTraduida.value = this.gestorOpenAI.getVeuTraduida();

                
                formApi.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.gestorOpenAI.setApiKey(apiKeyInput.value);
                    this.gestorOpenAI.setVeuOriginal(veuOriginalSelect.value);
                    this.gestorOpenAI.setVeuTraduida(veuTraduida.value);
                    this.gestorOpenAI.setIdiomaOriginal(idiomaOriginalDef.value);
                    this.gestorOpenAI.setIdiomaTraduccio(idiomaTraduccioDef.value);
                    modalConfig.classList.add('hidden');
                    this.comprovarConfiguracio();
                });
                
                mostrarApiKey.addEventListener('change', (e) => {
                    apiKeyInput.type = e.target.checked ? 'text' : 'password';
                });
                
                // Assegurar-nos que l'indicador d'estat est√† ocult a l'inici
                const estatTraduccio = document.getElementById('estat-traduccio');
                estatTraduccio.classList.add('hidden');
            }
            
            mostrarModalConfiguracio() {
                const modalConfig = document.getElementById('modal-configuracio');
                modalConfig.classList.remove('hidden');

            }


            
            async processarAudio(blob) {

                if (!this.gestorOpenAI.isConfigured()) {
                    alert('Cal configurar la clau API d\'OpenAI primer.');
                    this.mostrarModalConfiguracio();
                    return;
                }

                try {
                    // Guardar l'√†udio original
                    const audioOriginal = blob;
                    
                    // Mostrar el loader de c√†rrega
                    this.mostrarEstatProcessant('Transcrivint √†udio...');
                    
                    // 1. Transcriure √†udio original a text
                    const transcripcio = await this.gestorOpenAI.transcriureAudio(blob);
                    console.log('Transcripci√≥:', transcripcio);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Traduint text...');
                    
                    // 2. Traduir el text a l'idioma dest√≠
                    const idiomaOrigen = document.getElementById('idioma-origen').value;
                    const idiomaDesti = document.getElementById('idioma-desti').value;
                    const traduccio = await this.gestorOpenAI.traduirText(transcripcio, idiomaOrigen, idiomaDesti);
                    console.log('Traducci√≥:', traduccio);
                    
                    // Mostrar textos
                    this.mostrarTextos(transcripcio, traduccio);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Generant √†udio...');
                    
                    // 3. Convertir la traducci√≥ a √†udio
                    const audioTraduit = await this.gestorOpenAI.textAAudio(traduccio, idiomaDesti);
                    
                    // Reproduir √†udio tradu√Øt i original
                    this.reproduirAudios(audioOriginal, audioTraduit);
                } catch (error) {
                    console.error('Error en el proc√©s de traducci√≥:', error);
                    const missatgeError = error.message || 'Error en processar l\'√†udio';
                    
                    const estatTraduccio = document.getElementById('estat-traduccio');
                    const missatgeEstat = document.getElementById('missatge-estat');
                    
                    missatgeEstat.textContent = missatgeError;
                    
                    // Canviar l'estil del loader per indicar error
                    const loader = document.getElementById('loader-traduccio');
                    loader.classList.remove('border-blue-500', 'animate-spin');
                    loader.classList.add('border-red-500');
                    
                    setTimeout(() => {
                        estatTraduccio.classList.add('hidden');
                        // Restablir el loader
                        loader.classList.remove('border-red-500');
                        loader.classList.add('border-blue-500', 'animate-spin');
                    }, 5000);
                }
            }
            
            mostrarEstatProcessant(missatge) {
                const estatTraduccio = document.getElementById('estat-traduccio');
                const missatgeEstat = document.getElementById('missatge-estat');
                
                estatTraduccio.classList.remove('hidden');
                missatgeEstat.textContent = missatge;
            }
            
            mostrarTextos(transcripcio, traduccio) {
                this.ultimaTranscripcio = transcripcio;
                this.ultimaTraduccio = traduccio;
                
                const contenidorTextos = document.getElementById('textos-traduccio');
                contenidorTextos.classList.remove('hidden');
                
                const contenidorTranscripcio = document.getElementById('text-transcripcio');
                const contenidorTraduccio = document.getElementById('text-traduccio');
                
                contenidorTranscripcio.textContent = transcripcio;
                contenidorTraduccio.textContent = traduccio;
            }
            
            reproduirAudioTraduit(blob) {
                // Ocultar l'indicador de c√†rrega
                const estatTraduccio = document.getElementById('estat-traduccio');
                estatTraduccio.classList.add('hidden');
                
                const reproductorAudio = document.getElementById('reproductor-audio');
                const audio = document.getElementById('audio-reproductor');
                
                const url = URL.createObjectURL(blob);
                audio.src = url;
                reproductorAudio.classList.remove('hidden');
                audio.play();
                
                // Afegir a l'historial (utilitza la √∫ltima transcripci√≥ i traducci√≥ guardades)
                this.afegirAHistorial(blob, this.ultimaTranscripcio, this.ultimaTraduccio);
                
                // Restablir valors per la seg√ºent traducci√≥
                this.ultimaTranscripcio = '';
                this.ultimaTraduccio = '';
            }
            
            
            // Modifica el m√®tode afegirAHistorial per afegir botons de desc√†rrega a l'historial
            afegirAHistorial(audioBlobOriginal, audioBlobTraduit, transcripcio, traduccio) {
                const llistaHistorial = document.getElementById('llista-historial');
                const element = document.createElement('div');
                element.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4';
                
                const dataActual = new Date().toLocaleString('ca-ES');
                const idiomaOrigen = document.getElementById('idioma-origen').selectedOptions[0].text;
                const idiomaDesti = document.getElementById('idioma-desti').selectedOptions[0].text;
                
                const audioUrlOriginal = URL.createObjectURL(audioBlobOriginal);
                const audioUrlTraduit = URL.createObjectURL(audioBlobTraduit);
                
                // Generar noms d'arxiu √∫nics per a la desc√†rrega
                const timestamp = new Date().getTime();
                const nomArxiuOriginal = `audio_original_${idiomaOrigen.toLowerCase()}_${timestamp}.mp3`;
                const nomArxiuTraduit = `audio_traduit_${idiomaDesti.toLowerCase()}_${timestamp}.mp3`;
                
                element.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-3">
                        <div>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${dataActual}</span>
                            <span class="ml-2 text-sm font-medium text-gray-800 dark:text-white">
                                ${idiomaOrigen} ‚Üí ${idiomaDesti}
                            </span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">√Äudio original:</span>
                                <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm flex items-center descarregar-historial  cursor-pointer" 
                                        data-url="${audioUrlOriginal}" 
                                        data-nom="${nomArxiuOriginal}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                            </div>
                            <audio controls class="w-full mt-1">
                                <source src="${audioUrlOriginal}" type="audio/mp3">
                                El teu navegador no suporta l'element d'√†udio.
                            </audio>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">√Äudio tradu√Øt:</span>
                                <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm flex items-center descarregar-historial  cursor-pointer" 
                                        data-url="${audioUrlTraduit}" 
                                        data-nom="${nomArxiuTraduit}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                    Descarregar
                                </button>
                            </div>
                            <audio controls class="w-full mt-1">
                                <source src="${audioUrlTraduit}" type="audio/mp3">
                                El teu navegador no suporta l'element d'√†udio.
                            </audio>
                        </div>
                    </div>
                    <div class="text-sm border-t border-gray-200 dark:border-gray-600 pt-2">
                        <div class="mb-2">
                            <span class="font-medium text-gray-700 dark:text-gray-300">Transcripci√≥:</span>
                            <p class="text-gray-800 dark:text-gray-200">${transcripcio}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700 dark:text-gray-300">Traducci√≥:</span>
                            <p class="text-gray-800 dark:text-gray-200">${traduccio}</p>
                        </div>
                    </div>
                `;
                
                llistaHistorial.insertBefore(element, llistaHistorial.firstChild);
                
                // Configurar els botons de desc√†rrega de l'historial
                const botonsDescarrega = element.querySelectorAll('.descarregar-historial');
                botonsDescarrega.forEach(boto => {
                    boto.addEventListener('click', () => {
                        const url = boto.getAttribute('data-url');
                        const nomArxiu = boto.getAttribute('data-nom');
                        
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = nomArxiu;
                        document.body.appendChild(a);
                        a.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(a);
                        }, 100);
                    });
                });
                
                // Netejar URL objects antics per evitar fuites de mem√≤ria
                if (llistaHistorial.children.length > 5) {
                    for (let i = 5; i < llistaHistorial.children.length; i++) {
                        const audioElements = llistaHistorial.children[i].querySelectorAll('audio');
                        audioElements.forEach(audioElement => {
                            if (audioElement && audioElement.src) {
                                URL.revokeObjectURL(audioElement.src);
                            }
                        });
                        llistaHistorial.removeChild(llistaHistorial.children[i]);
                    }
                }
            }

            configurarModes() {
                // Elements de la UI
                const botoModeMicrofon = document.getElementById('mode-microfon');
                const botoModeText = document.getElementById('mode-text');
                const botoModeImatge = document.getElementById('mode-imatge'); // Nou
                const contingutMicrofon = document.getElementById('contingut-microfon');
                const contingutText = document.getElementById('contingut-text');
                const contingutImatge = document.getElementById('contingut-imatge'); // Nou
                const botoTraduirText = document.getElementById('boto-traduir-text');
                
                // Esdeveniments per canviar mode
                botoModeMicrofon.addEventListener('click', () => {
                    this.canviarMode('microfon');
                });
                
                botoModeText.addEventListener('click', () => {
                    this.canviarMode('text');
                });
                
                botoModeImatge.addEventListener('click', () => {
                    this.canviarMode('imatge');
                });

                // Configurar event per traduir text
                botoTraduirText.addEventListener('click', () => {
                    const text = document.getElementById('entrada-text').value.trim();
                    if (text) {
                        this.processarTextDirecte(text);
                    } else {
                        alert('Si us plau, introdueix algun text per traduir.');
                    }
                });

                // Configurar event per traduir text
                botoTraduirText.addEventListener('click', () => {
                    const text = document.getElementById('entrada-text').value.trim();
                    if (text) {
                        this.processarTextDirecte(text);
                    } else {
                        alert('Si us plau, introdueix algun text per traduir.');
                    }
                });
                
                // Configurar gesti√≥ d'imatges
                this.configurarGestioImatges();


            }

            canviarMode(mode) {
                const botoModeMicrofon = document.getElementById('mode-microfon');
                const botoModeText = document.getElementById('mode-text');
                const botoModeImatge = document.getElementById('mode-imatge'); // Nou
                const contingutMicrofon = document.getElementById('contingut-microfon');
                const contingutText = document.getElementById('contingut-text');
                const contingutImatge = document.getElementById('contingut-imatge'); // Nou

                
                // if (mode === 'microfon') {
                //     // Activar mode micr√≤fon
                //     botoModeMicrofon.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                //     botoModeMicrofon.classList.add('bg-blue-600', 'text-white');
                    
                //     botoModeText.classList.remove('bg-blue-600', 'text-white');
                //     botoModeText.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white');
                    
                //     contingutMicrofon.classList.remove('hidden');
                //     contingutText.classList.add('hidden');
                // } else if (mode === 'text') {
                //     // Activar mode text
                //     botoModeMicrofon.classList.remove('bg-blue-600', 'text-white');
                //     botoModeMicrofon.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white');
                    
                //     botoModeText.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                //     botoModeText.classList.add('bg-blue-600', 'text-white');
                    
                //     contingutMicrofon.classList.add('hidden');
                //     contingutText.classList.remove('hidden');
                    
                //     // Si estava gravant, aturar la gravaci√≥
                //     if (this.gestorAudio.gravant) {
                //         this.gestorAudio.aturarGravacio();
                //     }
                // }
                    
                // Resetejem tots els botons
                botoModeMicrofon.classList.remove('bg-blue-600', 'text-white');
                botoModeMicrofon.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white');
                
                botoModeText.classList.remove('bg-blue-600', 'text-white');
                botoModeText.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white');
                
                botoModeImatge.classList.remove('bg-blue-600', 'text-white'); // Nou
                botoModeImatge.classList.add('bg-white', 'text-gray-900', 'dark:bg-gray-700', 'dark:text-white'); // Nou
                
                // Activem el mode seleccionat
                if (mode === 'microfon') {
                    botoModeMicrofon.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                    botoModeMicrofon.classList.add('bg-blue-600', 'text-white');
                    contingutMicrofon.classList.remove('hidden');
                    contingutText.classList.add('hidden');
                    contingutImatge.classList.add('hidden');
                } else if (mode === 'text') {
                    botoModeText.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                    botoModeText.classList.add('bg-blue-600', 'text-white');
                    contingutMicrofon.classList.add('hidden');
                    contingutText.classList.remove('hidden');
                    contingutImatge.classList.add('hidden');
                } else if (mode === 'imatge') { // Nou
                    botoModeImatge.classList.remove('bg-white', 'text-gray-900', 'dark:bg-gray-700');
                    botoModeImatge.classList.add('bg-blue-600', 'text-white');
                    contingutMicrofon.classList.add('hidden');
                    contingutText.classList.add('hidden');
                    contingutImatge.classList.remove('hidden');
                }
                
                // Si estava gravant, aturar la gravaci√≥
                if (this.gestorAudio.gravant) {
                    this.gestorAudio.aturarGravacio();
                }
                
                // Amaguem els resultats de traducci√≥ d'imatge
                const resultatsImatge = document.getElementById('resultats-imatge');
                if (resultatsImatge) {
                    resultatsImatge.classList.add('hidden');
                }
            }

            async processarTextDirecte(text) {
                if (!this.gestorOpenAI.isConfigured()) {
                    alert('Cal configurar la clau API d\'OpenAI primer.');
                    this.mostrarModalConfiguracio();
                    return;
                }

                try {
                    // Mostrar el loader de c√†rrega
                    this.mostrarEstatProcessant('Generant √†udio original...');
                    
                    // Guardar la transcripci√≥ (en aquest cas, el text introdu√Øt)
                    this.ultimaTranscripcio = text;
                    
                    // Generar √†udio a partir del text original
                    const idiomaOrigen = document.getElementById('idioma-origen').value;
                    const audioOriginal = await this.gestorOpenAI.generarAudioOriginal(text, idiomaOrigen);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Traduint text...');
                    
                    // Traduir el text a l'idioma dest√≠
                    const idiomaDesti = document.getElementById('idioma-desti').value;
                    const traduccio = await this.gestorOpenAI.traduirText(text, idiomaOrigen, idiomaDesti);
                    console.log('Traducci√≥:', traduccio);
                    
                    // Guardar la traducci√≥
                    this.ultimaTraduccio = traduccio;
                    
                    // Mostrar textos
                    this.mostrarTextos(text, traduccio);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Generant √†udio tradu√Øt...');
                    
                    // Convertir la traducci√≥ a √†udio
                    const audioTraduit = await this.gestorOpenAI.textAAudio(traduccio, idiomaDesti);
                    
                    // Reproduir √†udio tradu√Øt i original
                    this.reproduirAudios(audioOriginal, audioTraduit);
                } catch (error) {
                    console.error('Error en el proc√©s de traducci√≥:', error);
                    const missatgeError = error.message || 'Error en processar el text';
                    
                    const estatTraduccio = document.getElementById('estat-traduccio');
                    const missatgeEstat = document.getElementById('missatge-estat');
                    
                    missatgeEstat.textContent = missatgeError;
                    
                    // Canviar l'estil del loader per indicar error
                    const loader = document.getElementById('loader-traduccio');
                    loader.classList.remove('border-blue-500', 'animate-spin');
                    loader.classList.add('border-red-500');
                    
                    setTimeout(() => {
                        estatTraduccio.classList.add('hidden');
                        // Restablir el loader
                        loader.classList.remove('border-red-500');
                        loader.classList.add('border-blue-500', 'animate-spin');
                    }, 5000);
                }
            }

            // Configurar la gesti√≥ d'imatges
            // M√®tode configurarGestioImatges revisat per utilitzar la classe zona-imatge i millorar els efectes visuals
            configurarGestioImatges() {
                const entradaImatge = document.getElementById('entrada-imatge');
                const dropZone = document.querySelector('label[for="entrada-imatge"]'); // Zona on arrossegar
                const previsualitzacioImatge = document.getElementById('previsualitzacio-imatge');
                const imatgePujada = document.getElementById('imatge-pujada');
                const eliminarImatge = document.getElementById('eliminar-imatge');
                const botoTraduirImatge = document.getElementById('boto-traduir-imatge');
                const resultatsImatge = document.getElementById('resultats-imatge');
                
                // Variable per emmagatzemar les dades de la imatge
                this.imatgeActual = null;
                
                // Gestionar quan es puja una imatge a trav√©s de l'input file
                entradaImatge.addEventListener('change', (event) => {
                    const fitxer = event.target.files[0];
                    if (fitxer) {
                        this.processarFitxerImatge(fitxer);
                    }
                });
                
                // Gestionar arrossegar i deixar anar (drag & drop)
                
                // Prevenir el comportament per defecte de l'arrossegament
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // Afegir classes d'estil quan s'arrossega sobre la zona
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropZone.classList.add('drag-active');
                }
                
                function unhighlight() {
                    dropZone.classList.remove('drag-active');
                }
                
                // Gestionar quan es deixa anar un fitxer
                dropZone.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const fitxer = dt.files[0];
                    if (fitxer) {
                        this.processarFitxerImatge(fitxer);
                    }
                });
                
                // Gestionar quan es vol eliminar la imatge
                eliminarImatge.addEventListener('click', () => {
                    entradaImatge.value = '';
                    previsualitzacioImatge.classList.add('hidden');
                    botoTraduirImatge.classList.add('hidden');
                    resultatsImatge.classList.add('hidden');
                    this.imatgeActual = null;
                });
                
                // Gestionar el bot√≥ de traduir imatge
                botoTraduirImatge.addEventListener('click', () => {
                    if (this.imatgeActual) {
                        this.processarImatge(this.imatgeActual);
                    } else {
                        alert('Si us plau, puja una imatge primer.');
                    }
                });
            }            


            // Nou m√®tode per processar un fitxer d'imatge (reutilitzat tant per l'input com pel drag & drop)
            processarFitxerImatge(fitxer) {
                const previsualitzacioImatge = document.getElementById('previsualitzacio-imatge');
                const imatgePujada = document.getElementById('imatge-pujada');
                const botoTraduirImatge = document.getElementById('boto-traduir-imatge');
                const resultatsImatge = document.getElementById('resultats-imatge');
                
                // Comprovar mida m√†xima (5MB)
                if (fitxer.size > 5 * 1024 * 1024) {
                    alert('La imatge √©s massa gran. Mida m√†xima permesa: 5MB');
                    return;
                }
                
                // Comprovar tipus de fitxer
                if (!['image/jpeg', 'image/jpg', 'image/png'].includes(fitxer.type)) {
                    alert('Format d\'imatge no suportat. Si us plau, utilitza PNG, JPG o JPEG.');
                    return;
                }
                
                // Llegir i mostrar la imatge
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Guardar les dades de la imatge en base64
                    const base64String = e.target.result.split(',')[1];
                    this.imatgeActual = base64String;
                    
                    // Mostrar la previsualitzaci√≥
                    imatgePujada.src = e.target.result;
                    previsualitzacioImatge.classList.remove('hidden');
                    botoTraduirImatge.classList.remove('hidden');
                    
                    // Amagar els resultats si hi havia
                    resultatsImatge.classList.add('hidden');
                };
                reader.readAsDataURL(fitxer);
            }

            reproduirAudios(blobOriginal, blobTraduit) {
                // Ocultar l'indicador de c√†rrega
                const estatTraduccio = document.getElementById('estat-traduccio');
                estatTraduccio.classList.add('hidden');
                
                const reproductorAudio = document.getElementById('reproductor-audio');
                const audioOriginal = document.getElementById('audio-original');
                const audioTraduit = document.getElementById('audio-reproductor');

                // Guardar els blobs d'√†udio per a la possible desc√†rrega
                this.ultimAudioOriginal = blobOriginal;
                this.ultimAudioTraduit = blobTraduit;
                
                // Configurar l'√†udio original
                const urlOriginal = URL.createObjectURL(blobOriginal);
                audioOriginal.src = urlOriginal;
                
                // Configurar l'√†udio tradu√Øt
                const urlTraduit = URL.createObjectURL(blobTraduit);
                audioTraduit.src = urlTraduit;
                
                reproductorAudio.classList.remove('hidden');
                audioTraduit.play();
                
                // Afegir a l'historial (utilitza la √∫ltima transcripci√≥ i traducci√≥ guardades)
                this.afegirAHistorial(blobOriginal, blobTraduit, this.ultimaTranscripcio, this.ultimaTraduccio);
                
                // Restablir valors per la seg√ºent traducci√≥
                this.ultimaTranscripcio = '';
                this.ultimaTraduccio = '';
            }

            configurarBotonsDescarrega() {
                const botoDescarregarOriginal = document.getElementById('descarregar-audio-original');
                const botoDescarregarTraduit = document.getElementById('descarregar-audio-traduit');
                
                botoDescarregarOriginal.addEventListener('click', () => {
                    if (this.ultimAudioOriginal) {
                        const idiomaOrigen = document.getElementById('idioma-origen').value;
                        this.descarregarAudio(this.ultimAudioOriginal, `audio_original_${idiomaOrigen}.mp3`);
                    }
                });
                
                botoDescarregarTraduit.addEventListener('click', () => {
                    if (this.ultimAudioTraduit) {
                        const idiomaDesti = document.getElementById('idioma-desti').value;
                        this.descarregarAudio(this.ultimAudioTraduit, `audio_traduit_${idiomaDesti}.mp3`);
                    }
                });
            }

            // Afegeix aquest nou m√®tode a la classe AplicacioTraductor
            descarregarAudio(blob, nomArxiu) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = nomArxiu;
                document.body.appendChild(a);
                a.click();
                
                // Neteja despr√©s de la desc√†rrega
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }

            configurarBotoIntercanvi() {
                const botoIntercanvi = document.getElementById('intercanviar-idiomes');
                if (botoIntercanvi) {
                    botoIntercanvi.addEventListener('click', () => {
                        const selectOrigen = document.getElementById('idioma-origen');
                        const selectDesti = document.getElementById('idioma-desti');
                        
                        // Guardem els valors actuals
                        const valorOrigen = selectOrigen.value;
                        const valorDesti = selectDesti.value;
                        
                        // Intercanviem els valors
                        selectOrigen.value = valorDesti;
                        selectDesti.value = valorOrigen;
                        
                        // Actualitzem la configuraci√≥ desada
                        if (this.gestorOpenAI) {
                            this.gestorOpenAI.setIdiomaOriginal(valorDesti);
                            this.gestorOpenAI.setIdiomaTraduccio(valorOrigen);
                        }
                    });
                }
            }

            // Mostrar resultats de la traducci√≥ d'imatge
            mostrarResultatsImatge(textOriginal, textTraduit) {
                const resultatsImatge = document.getElementById('resultats-imatge');
                const textImatgeOriginal = document.getElementById('text-imatge-original');
                const textImatgeTraduit = document.getElementById('text-imatge-traduit');
                
                textImatgeOriginal.textContent = textOriginal;
                textImatgeTraduit.textContent = textTraduit;
                
                resultatsImatge.classList.remove('hidden');

                // Guardar la traducci√≥ per a possibles usos futurs (com generar √†udio)
                this.ultimTraduccioImatge = textTraduit;

                // Configurar el bot√≥ d'√†udio
                this.configurarBotoAudioImatge();
                
                // Tamb√© podr√≠em afegir aix√≤ a l'historial si volgu√©ssim
                this.afegirAHistorialImatge(textOriginal, textTraduit);
            }

            
            // 2. Afegeix aquest nou m√®tode per configurar el bot√≥ d'√†udio de la imatge
            configurarBotoAudioImatge() {
                const botoAudioImatge = document.getElementById('boto-audio-imatge');
                const descarregarAudioImatge = document.getElementById('descarregar-audio-imatge');
                const audioImatgeContainer = document.getElementById('audio-imatge-container');
                const audioImatgeReproductor = document.getElementById('audio-imatge-reproductor');
                
                // Variable per emmagatzemar el blob d'√†udio
                this.blobAudioImatge = null;
                
                botoAudioImatge.addEventListener('click', async () => {
                    if (!this.ultimTraduccioImatge) {
                        alert('No hi ha text per convertir a √†udio.');
                        return;
                    }
                    
                    try {
                        // Mostrar indicador de c√†rrega
                        botoAudioImatge.disabled = true;
                        botoAudioImatge.classList.add('opacity-50');
                        botoAudioImatge.querySelector('svg').classList.add('animate-pulse');
                        botoAudioImatge.textContent = "Generant √†udio...";
                        
                        // Obtenir l'idioma dest√≠ seleccionat
                        const idiomaDestiSelect = document.getElementById('idioma-desti');
                        const idiomaDestiCodi = idiomaDestiSelect.options[idiomaDestiSelect.selectedIndex].dataset.codi;
                        
                        // Generar √†udio a partir del text tradu√Øt
                        this.blobAudioImatge = await this.gestorOpenAI.textAAudio(this.ultimTraduccioImatge, idiomaDestiCodi);
                        
                        // Configurar el reproductor d'√†udio
                        const audioUrl = URL.createObjectURL(this.blobAudioImatge);
                        audioImatgeReproductor.src = audioUrl;
                        audioImatgeContainer.classList.remove('hidden');
                        
                        // Mostrar el bot√≥ de desc√†rrega
                        descarregarAudioImatge.classList.remove('hidden');
                        descarregarAudioImatge.classList.add('flex');
                        
                        // Reproduir autom√†ticament
                        audioImatgeReproductor.play();
                        
                    } catch (error) {
                        console.error('Error en generar √†udio:', error);
                        alert('Error en generar √†udio: ' + error.message);
                    } finally {
                        // Restaurar l'estat del bot√≥
                        botoAudioImatge.disabled = false;
                        botoAudioImatge.classList.remove('opacity-50');
                        botoAudioImatge.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" />
                            </svg>
                            Escoltar traducci√≥
                        `;
                    }
                });
                
                // Configurar el bot√≥ de desc√†rrega d'√†udio
                descarregarAudioImatge.addEventListener('click', () => {
                    if (this.blobAudioImatge) {
                        const idiomaDestiSelect = document.getElementById('idioma-desti');
                        const idiomaDestiNom = idiomaDestiSelect.options[idiomaDestiSelect.selectedIndex].text;
                        const nomArxiu = `traduccio_imatge_${idiomaDestiNom.toLowerCase()}_${new Date().getTime()}.mp3`;
                        
                        const url = URL.createObjectURL(this.blobAudioImatge);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = nomArxiu;
                        document.body.appendChild(a);
                        a.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        }, 100);
                    }
                });
            }


            async processarImatge(imatgeBase64) {
                if (!this.gestorOpenAI.isConfigured()) {
                    alert('Cal configurar la clau API d\'OpenAI primer.');
                    this.mostrarModalConfiguracio();
                    return;
                }
                
                try {
                    // Mostrar el loader de c√†rrega
                    this.mostrarEstatProcessant('Extraient text de la imatge...');

                    const selectOrigen = document.getElementById('idioma-origen');
                    const selectDesti = document.getElementById('idioma-desti');
                    
                    // 1. Extreure text de la imatge
                    const textExtret = await this.gestorOpenAI.extraureTextImatge(imatgeBase64, selectDesti);
                                        
                    if (!textExtret || textExtret.toLowerCase().includes('no hi ha text') || textExtret.toLowerCase().includes('no text')) {
                        this.mostrarResultatsImatge('No s\'ha detectat text a la imatge.', '');
                        const estatTraduccio = document.getElementById('estat-traduccio');
                        estatTraduccio.classList.add('hidden');
                        return;
                    }
                    
                    console.log('Text extret de la imatge:', textExtret);
                    
                    // Actualitzar estat
                    this.mostrarEstatProcessant('Traduint text...');
                    
                    // 2. Obtenir els codis d'idioma dels selectors
                    const idiomaOrigenSelect = document.getElementById('idioma-origen').value;
                    const idiomaDestiSelect = document.getElementById('idioma-desti').value;
                    
                    // Obtenir els codis d'idioma, no els noms
                    // const idiomaOrigenCodi = idiomaOrigenSelect.options[idiomaOrigenSelect.selectedIndex].dataset.codi;
                    // const idiomaDestiCodi = idiomaDestiSelect.options[idiomaDestiSelect.selectedIndex].dataset.codi;
                    
                    // 3. Traduir el text utilitzant els codis d'idioma correctes
                    // const traduccio = await this.gestorOpenAI.traduirText(textExtret, idiomaOrigenCodi, idiomaDestiCodi);
                    const traduccio = await this.gestorOpenAI.traduirText(textExtret, idiomaOrigenSelect, idiomaDestiSelect);
                    
                    console.log('Traducci√≥:', traduccio);
                    
                    // 4. Mostrar els resultats
                    this.mostrarResultatsImatge(textExtret, traduccio);
                    
                    // Ocultar el loader
                    const estatTraduccio = document.getElementById('estat-traduccio');
                    estatTraduccio.classList.add('hidden');
                    
                } catch (error) {
                    console.error('Error en processar la imatge:', error);
                    const missatgeError = error.message || 'Error en processar la imatge';
                    
                    const estatTraduccio = document.getElementById('estat-traduccio');
                    const missatgeEstat = document.getElementById('missatge-estat');
                    
                    missatgeEstat.textContent = missatgeError;
                    
                    // Canviar l'estil del loader per indicar error
                    const loader = document.getElementById('loader-traduccio');
                    loader.classList.remove('border-blue-500', 'animate-spin');
                    loader.classList.add('border-red-500');
                    
                    setTimeout(() => {
                        estatTraduccio.classList.add('hidden');
                        // Restablir el loader
                        loader.classList.remove('border-red-500');
                        loader.classList.add('border-blue-500', 'animate-spin');
                    }, 5000);
                }
            }

            // Afegir traduccions d'imatges a l'historial
            afegirAHistorialImatge(textOriginal, textTraduit) {
                const llistaHistorial = document.getElementById('llista-historial');
                const element = document.createElement('div');
                element.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4';
                
                const dataActual = new Date().toLocaleString('ca-ES');
                const idiomaOrigen = document.getElementById('idioma-origen').selectedOptions[0].text;
                const idiomaDesti = document.getElementById('idioma-desti').selectedOptions[0].text;
                
                element.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2 mb-3">
                        <div>
                            <span class="text-sm text-gray-600 dark:text-gray-400">${dataActual}</span>
                            <span class="ml-2 text-sm font-medium text-gray-800 dark:text-white">
                                ${idiomaOrigen} ‚Üí ${idiomaDesti} (Imatge)
                            </span>
                        </div>
                    </div>
                    <div class="text-sm border-t border-gray-200 dark:border-gray-600 pt-2">
                        <div class="mb-2">
                            <span class="font-medium text-gray-700 dark:text-gray-300">Text original:</span>
                            <p class="text-gray-800 dark:text-gray-200">${textOriginal}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700 dark:text-gray-300">Traducci√≥:</span>
                            <p class="text-gray-800 dark:text-gray-200">${textTraduit}</p>
                        </div>
                    </div>
                `;
                
                llistaHistorial.insertBefore(element, llistaHistorial.firstChild);
            }


        }

        // Iniciar l'aplicaci√≥
        document.addEventListener('DOMContentLoaded', () => {

            const optionsIdioma = generarOptionsSelect(idiomesJSON, "catala")
            
            //frontend
            inserirOptionsSelect("idioma-traduccio", optionsIdioma)
            inserirOptionsSelect("idioma-original", optionsIdioma)

            //Configuracio
            inserirOptionsSelect("idioma-desti", optionsIdioma)
            inserirOptionsSelect("idioma-origen", optionsIdioma)


 
            const themeToggle = document.getElementById('tema-toggle');
            const themeIcon = document.getElementById('tema-icon');

            const idiomaOrigen = document.getElementById('idioma-origen');
            const idiomaDesti = document.getElementById('idioma-desti');

            idiomaOrigen.value = localStorage.getItem('idioma-original') || 'Catalan';  // catal√†
            idiomaDesti.value  = localStorage.getItem('idioma-traduccio') || 'English'; // angl√®s

        
            // Aplicar tema inicial
            const savedTheme = localStorage.getItem('tema') || 'clar';
                        
            if (savedTheme === 'fosc') {
                document.documentElement.classList.add('dark');
                themeIcon.textContent = '‚òÄÔ∏è';
            }
            
            // Configurar el toggle
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                
                if (isDark) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('tema', 'clar');
                    themeIcon.textContent = 'üåô';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('tema', 'fosc');
                    themeIcon.textContent = '‚òÄÔ∏è';
                }
            });



            window.app = new AplicacioTraductor();
        });
    </script>
</body>
</html>